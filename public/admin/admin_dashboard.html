<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | UBigkas</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Poppins', sans-serif; padding: 30px; background: #f5f5f5; }
    h1 { color: #7a0c0c; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #7a0c0c; color: #fff; }
    tr:hover { background: #f0f0f0; }
    button { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
    .approve { background: #28a745; color: white; margin-right: 5px; }
    .deny { background: #dc3545; color: white; }
</style>
</head>
<body>

<h1>Pending Teacher Accounts</h1>
<table id="pendingTeachersTable">
    <thead>
        <tr>
            <th>Email</th>
            <th>Teacher ID</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Rows will be injected here -->
    </tbody>
</table>

<script type="module">
import { db } from "../firebase.js";
import { collection, getDocs, setDoc, doc, deleteDoc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Reference to the table body
const tbody = document.querySelector("#pendingTeachersTable tbody");

// Fetch pending teacher accounts
async function loadPendingTeachers() {
    tbody.innerHTML = ""; // clear table
    try {
        const pendingSnap = await getDocs(collection(db, "pending_teacher_accounts"));
        pendingSnap.forEach(docSnap => {
            const data = docSnap.data();
            const tr = document.createElement("tr");

            // Format date
            const createdAt = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : "-";

            tr.innerHTML = `
                <td>${data.email}</td>
                <td>${data.teacherId}</td>
                <td>${createdAt}</td>
                <td>
                    <button class="approve">✔</button>
                    <button class="deny">✖</button>
                </td>
            `;

            // Approve button
            tr.querySelector(".approve").onclick = async () => {
                try {
                    // Move to teacher_accounts
                    await setDoc(doc(db, "teacher_accounts", docSnap.id), {
                        email: data.email,
                        teacherId: data.teacherId,
                        role: "teacher",
                        createdAt: serverTimestamp()
                    });
                    // Delete from pending
                    await deleteDoc(doc(db, "pending_teacher_accounts", docSnap.id));
                    tr.remove();
                    alert(`${data.email} approved!`);
                } catch (err) {
                    console.error(err);
                    alert("Failed to approve.");
                }
            };

            // Deny button
            tr.querySelector(".deny").onclick = async () => {
                if (!confirm("Are you sure you want to deny this account?")) return;
                try {
                    await deleteDoc(doc(db, "pending_teacher_accounts", docSnap.id));
                    tr.remove();
                    alert(`${data.email} denied.`);
                } catch (err) {
                    console.error(err);
                    alert("Failed to deny.");
                }
            };

            tbody.appendChild(tr);
        });

        if (tbody.children.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="4" style="text-align:center;">No pending accounts.</td>`;
            tbody.appendChild(tr);
        }

    } catch (err) {
        console.error("Error fetching pending teachers:", err);
        alert("Failed to load pending teachers.");
    }
}

// Load table on page load
loadPendingTeachers();
</script>

</body>
</html>

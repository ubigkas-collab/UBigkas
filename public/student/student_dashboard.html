<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard | UBigkas</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
  /* ===== TEXT SCALING VARIABLE ===== */
  :root {
    --text-scale: 100%;
  }

  body {
    font-size: var(--text-scale);
    transition: background-color 0.3s ease;
    margin: 0;
    overflow-x: hidden;
  }

  /* ===== DRIP EFFECT INTEGRATION ===== */
  #drip-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10000;
  }
  .drip-layer {
    position: absolute;
    top: -110%;
    left: 0;
    width: 100%;
    height: 120%;
    background-color: #181818;
    transition: top 0.7s cubic-bezier(0.645, 0.045, 0.355, 1);
    clip-path: url(#drip-path);
  }
  #drip-container.active .drip-layer {
    top: 0;
  }
  .drip-light { background-color: #fdfdfd !important; }

  /* ===== NAVIGATION UI ===== */
  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 5%;
    height: 80px;
    background-color: #ffffff;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
  }

  nav .logo {
    font-size: 1.8rem;
    font-weight: 800;
    text-decoration: none;
    color: #7a0c0c;
  }
  nav .logo span { color: #b38f00; }

  nav ul {
    display: flex;
    list-style: none;
    gap: 30px;
    margin: 0;
    padding: 0;
  }

  nav ul li a {
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: color 0.3s;
  }

  .nav-actions {
    margin-left: auto;
    display: flex;
    align-items: center;
  }

  /* ===== BURGER MENU BUTTON ===== */
  .burger-menu {
    display: none;
    flex-direction: column;
    gap: 5px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 10px;
    z-index: 1002; /* Above sidebar */
  }
  .burger-menu span {
    width: 25px;
    height: 3px;
    background-color: #7a0c0c;
    border-radius: 2px;
    transition: 0.3s;
  }

  /* ===== SETTINGS DROPDOWN ===== */
  .dropdown {
    position: relative;
    display: inline-block;
    padding-bottom: 15px; 
    margin-bottom: -15px;
  }

  #settingsBtn {
    padding: 10px 20px;
    border-radius: 25px;
    background-color: #7a0c0c;
    color: white;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
  }

  .dropdown-content {
    display: block; 
    opacity: 0;
    visibility: hidden;
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 220px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    z-index: 10001;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 10px;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    transition-delay: 0.8s; 
  }

  @media (min-width: 851px) {
    .dropdown:hover .dropdown-content {
        opacity: 1;
        visibility: visible;
        transition-delay: 0s; 
    }
  }

  .dropdown-content.is-active {
    opacity: 1 !important;
    visibility: visible !important;
    transition-delay: 0s !important;
  }

  .dropdown-content button {
    width: 100%;
    padding: 12px 16px;
    text-align: left;
    border: none;
    background: none;
    font-family: 'Poppins', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s;
    color: #333;
  }

  #logoutBtn { color: #d9534f !important; font-weight: 700; }

  /* ===== DARK MODE STYLES ===== */
  body.dark-mode { background-color: #181818; color: #ffffff; }
  body.dark-mode nav { background-color: #202020; color: #ffffff; }
  body.dark-mode nav ul li a, body.dark-mode nav .logo { color: #ffffff; }
  body.dark-mode .dropdown-content { background-color: #242424; border: 1px solid #333; }
  body.dark-mode .dropdown-content button { color: #e6e6e6; }
  body.dark-mode .dashboard-card, body.dark-mode .assessment-section, body.dark-mode .grammar-cards-section {
    background-color: #242424; color: #e6e6e6; border: 1px solid #333;
  }
  body.dark-mode .burger-menu span { background-color: #ffffff; }

  /* ===== MOBILE RESPONSIVE (LEFT SIDEBAR) ===== */
  @media (max-width: 850px) {
    nav {
      height: 70px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
    }

    .burger-menu {
      display: flex;
      grid-column: 1;
      justify-self: start;
    }

    nav .logo {
      grid-column: 2;
      justify-self: center;
      font-size: 1.5rem;
    }

    .nav-actions {
      grid-column: 3;
      justify-self: end;
    }

    /* Side Panel Navigation */
    nav ul {
      position: fixed;
      top: 0;
      left: -100%; /* Fully hidden */
      width: 280px;
      height: 100vh;
      background-color: #ffffff;
      flex-direction: column;
      padding: 100px 30px 30px 30px;
      gap: 25px;
      box-shadow: 10px 0 20px rgba(0,0,0,0.1);
      transition: left 0.4s cubic-bezier(0.77, 0, 0.175, 1);
      z-index: 1001;
    }

    nav ul.show {
      left: 0;
    }

    nav ul li a {
      font-size: 1.2rem;
      display: block;
      width: 100%;
    }

    body.dark-mode nav ul {
      background-color: #202020;
      box-shadow: 10px 0 20px rgba(0,0,0,0.4);
    }

    .dashboard-container { padding: 20px 5%; }
  }

  /* ===== DASHBOARD & CARDS ===== */
  .dashboard-container { padding: 40px 5%; max-width: 1200px; margin: 0 auto; }
  .dashboard-card.full-width { background: white; padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  .assessment-section { background: white; padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  .grammar-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
  .card-container { perspective: 1000px; cursor: pointer; height: 180px; }
  .card { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
  .card.is-flipped { transform: rotateY(180deg); }
  .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 15px; padding: 15px; }
  .card-front { background-color: #7a0c0c; color: white; font-weight: 700; }
  .card-back { background-color: #fff; color: #333; transform: rotateY(180deg); border: 1px solid #ddd; }
  .card-example { margin-top: 12px; font-style: italic; font-weight: 700; color: #d4af37; border-top: 1px dashed #ccc; padding-top: 8px; width: 90%; font-size: 0.9rem; }

  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 20000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
  .modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
  .modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
  .modal-btn { padding: 10px 25px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; }
  .modal-btn.primary { background-color: #d9534f; color: white; }
  .modal-btn.secondary { background-color: #e9ecef; color: #333; }
  .footer-credit { text-align: center; padding: 20px; color: #888; font-size: 0.8rem; }
  </style>

</head>
<body>

<div id="drip-container">
  <div id="dripLayer" class="drip-layer"></div>
  <svg width="0" height="0">
    <defs>
      <clipPath id="drip-path" clipPathUnits="objectBoundingBox">
        <path d="M0,0 L1,0 L1,0.8 C0.9,0.95 0.85,0.7 0.75,0.85 C0.65,1 0.55,0.75 0.5,0.9 C0.45,0.75 0.35,1 0.25,0.85 C0.15,0.7 0.1,0.95 0,0.8 Z"></path>
      </clipPath>
    </defs>
  </svg>
</div>

<nav>
  <button class="burger-menu" id="burgerBtn">
    <span></span><span></span><span></span>
  </button>

  <a href="index.html" class="logo">UB<span>igkas</span></a>
  
  <ul id="navLinks">
    <li><a href="student_dashboard.html">Home</a></li>
    <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>

  <div class="nav-actions">
    <div class="dropdown">
      <button id="settingsBtn">Settings ‚öôÔ∏è</button>
      <div class="dropdown-content" id="settingsDropdown">
        <button id="darkModeBtn">üåô Dark Mode</button>
        <button id="textSizeBtn">üîç Text Size: 100%</button>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;">
        <button id="logoutBtn">üö™ Logout</button>
      </div>
    </div>
  </div>
</nav>

<div id="logoutModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Logout Confirmation</h3>
    <p>Are you sure you want to logout?</p>
    <div class="modal-actions">
      <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
      <button id="confirmLogout" class="modal-btn primary">Logout</button>
    </div>
  </div>
</div>

<div class="dashboard-container">
  <div class="dashboard-card full-width">
    <h1>Welcome, <span id="studentName"></span>!</h1>
    <p class="subtitle">Class Group: <span id="classId"></span></p>
    <button class="btn" id="quizBtn" style="background:#7a0c0c; color:white; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; font-weight:600;">Take Grammar Quiz</button>
  </div>

  <div class="assessment-section">
    <h3>Assessment Performance</h3>
    <div style="width: 100%; height: 220px;">
      <canvas id="scoreChart"></canvas>
    </div>
  </div>

  <div class="assessment-section" style="margin-top: 20px;">
      <h3>Personalized Feedback</h3>
      <div id="feedbackContainer" style="text-align: left; padding: 10px;">
          <p style="color: #888;">Complete a quiz to see your feedback here!</p>
      </div>
  </div>

  <div class="grammar-cards-section">
    <h3>Filipino Grammar Rules</h3>
    <div class="grammar-cards">
      <div class="card-container" data-type="Pangngalan">
        <div class="card">
          <div class="card-face card-front">Pangngalan</div>
          <div class="card-face card-back">
            Names a person, place, thing, or idea
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>
      <div class="card-container" data-type="Pandiwa">
        <div class="card">
          <div class="card-face card-front">Pandiwa</div>
          <div class="card-face card-back">
            Shows an action or state of being
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>
      <div class="card-container" data-type="Pang-uri">
        <div class="card">
          <div class="card-face card-front">Pang-uri</div>
          <div class="card-face card-back">
            Describes a noun
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>
      <div class="card-container" data-type="Pang-abay">
        <div class="card">
          <div class="card-face card-front">Pang-abay</div>
          <div class="card-face card-back">
            Modifies verbs, adjectives, or adverbs
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>
      <div class="card-container" data-type="Panghalip">
        <div class="card">
          <div class="card-face card-front">Panghalip</div>
          <div class="card-face card-back">
            Replaces a noun 
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-credit">
    ¬©2025 University of Batangas ‚Äì Lipa City
  </div>
</div>

<script type="module">
import { auth, db } from "../firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { collection, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const studentName = sessionStorage.getItem("studentName") || "Student";
const studentUID  = sessionStorage.getItem("studentUID");
const classId     = sessionStorage.getItem("classId");

document.getElementById("studentName").textContent = studentName;
document.getElementById("classId").textContent = classId;

/* ===================== BURGER SIDEBAR LOGIC ===================== */
const burgerBtn = document.getElementById("burgerBtn");
const navLinks = document.getElementById("navLinks");

burgerBtn.onclick = (e) => {
    e.stopPropagation();
    navLinks.classList.toggle("show");
};

/* ===================== SETTINGS & GLOBAL CLICKS ===================== */
const settingsBtn = document.getElementById("settingsBtn");
const dropdownMenu = document.getElementById("settingsDropdown");

settingsBtn.onclick = (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("is-active");
};

document.addEventListener('click', (event) => {
    // Close settings if click outside
    if (!settingsBtn.contains(event.target)) {
        dropdownMenu.classList.remove("is-active");
    }
    // Close sidebar if click outside
    if (!burgerBtn.contains(event.target) && !navLinks.contains(event.target)) {
        navLinks.classList.remove("show");
    }
});

/* ===================== TEXT SIZE LOGIC ===================== */
const textSizeBtn = document.getElementById("textSizeBtn");
const sizes = ["100%", "115%", "130%"];
let currentSizeIndex = sizes.indexOf(localStorage.getItem("textSize") || "100%");
if(currentSizeIndex === -1) currentSizeIndex = 0;

function updateTextSize() {
  const newSize = sizes[currentSizeIndex];
  document.documentElement.style.setProperty('--text-scale', newSize);
  textSizeBtn.textContent = `üîç Text Size: ${newSize}`;
  localStorage.setItem("textSize", newSize);
}

textSizeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  currentSizeIndex = (currentSizeIndex + 1) % sizes.length;
  updateTextSize();
});
updateTextSize();

/* ===================== FEEDBACK & CHART LOGIC ===================== */
const feedbackPool = {
    needsImprovement: ["It seems there is some confusion with {quiz}. Let's review!", "Don't be discouraged! {quiz} can be tricky.", "Focus on {quiz} fundamentals."],
    proficient: ["Great job! You have a solid grasp of {quiz}.", "You're doing well with {quiz}. Keep it up!", "Good progress on {quiz}!"],
    advanced: ["Excellent! You have mastered {quiz}.", "Fantastic work on {quiz}!", "Outstanding performance! You are a pro at {quiz}."]
};

function formatQuizName(name) {
    const names = { vso: "Sentence Structure", pronouns: "Pronouns", affixes: "Verbs/Affixes", noun: "Nouns", adjective: "Adjectives", adverb: "Adverbs" };
    return names[name] || name;
}

function getFeedback(quizName, percentage) {
    let category = percentage < 75 ? "needsImprovement" : (percentage < 90 ? "proficient" : "advanced");
    const options = feedbackPool[category];
    return options[Math.floor(Math.random() * options.length)].replace("{quiz}", formatQuizName(quizName));
}

async function loadAssessmentScores(uid) {
  try {
    const ref = collection(db, "students", uid, "assessments");
    const snapshot = await getDocs(ref);
    const scoreMap = {};
    const feedbackContainer = document.getElementById("feedbackContainer");
    
    if (!snapshot.empty) feedbackContainer.innerHTML = "";

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const quiz = data.quizType || docSnap.id;
      const score = data.score ?? 0;
      const total = data.total ?? 1;
      const percentage = Math.round((score / total) * 100);

      if (!scoreMap[quiz] || score > scoreMap[quiz].score) { scoreMap[quiz] = { score, total }; }

      const div = document.createElement("div");
      div.className = "feedback-item";
      div.innerHTML = `<span class="feedback-quiz-name" style="font-weight:bold;">${formatQuizName(quiz)}:</span> ${getFeedback(quiz, percentage)}`;
      feedbackContainer.appendChild(div);
    });

    const labels = []; const values = [];
    for (const [quiz, val] of Object.entries(scoreMap)) {
      labels.push(quiz);
      values.push(Math.round((val.score / val.total) * 100));
    }
    if (labels.length) renderChart(labels, values);
  } catch (err) { console.error("Assessment load error:", err); }
}

function renderChart(labels, scores) {
  const ctx = document.getElementById("scoreChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ data: scores, backgroundColor: "#7a0c0c", borderRadius: 10 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 0, max: 100, ticks: { callback: v => v + "%" }, grid: { color: "#444" } },
        x: { grid: { color: "#444" } }
      }
    }
  });
}

/* ===================== AUTH & STATUS ===================== */
async function setStudentStatus(uid, status) {
  try {
    const studentRef = doc(db, "students", uid);
    await updateDoc(studentRef, { status: status, lastSeen: serverTimestamp() });
  } catch (err) { console.error("Status update failed:", err); }
}

onAuthStateChanged(auth, async user => {
  if (!user || !studentUID) { window.location.href = "../index.html"; }
  else { await setStudentStatus(studentUID, "online"); loadAssessmentScores(studentUID); }
});

/* ===================== UI INTERACTIONS ===================== */
document.getElementById("quizBtn").onclick = () => { window.location.href = "grammar_quiz.html"; };

const logoutBtn = document.getElementById("logoutBtn");
const logoutModal = document.getElementById("logoutModal");
const cancelLogout = document.getElementById("cancelLogout");
const confirmLogout = document.getElementById("confirmLogout");

logoutBtn.addEventListener('click', (e) => { e.stopPropagation(); logoutModal.style.display = "flex"; });
cancelLogout.onclick = () => { logoutModal.style.display = "none"; };

confirmLogout.onclick = async () => {
  if (studentUID) await setStudentStatus(studentUID, "offline");
  await signOut(auth);
  sessionStorage.clear();
  window.location.href = "../index.html";
};

/* ===================== THEME SWITCHER ===================== */
const darkModeBtn = document.getElementById("darkModeBtn");
const dripContainer = document.getElementById("drip-container");
const dripLayer = document.getElementById("dripLayer");

function updateThemeText(isDark) {
    darkModeBtn.innerHTML = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
}

darkModeBtn.onclick = (e) => {
  e.stopPropagation();
  const isDark = document.body.classList.contains("dark-mode");
  if (isDark) dripLayer.classList.add("drip-light");
  else dripLayer.classList.remove("drip-light");

  dripContainer.classList.add("active");

  setTimeout(() => {
    document.body.classList.toggle("dark-mode");
    const nowDark = document.body.classList.contains("dark-mode");
    updateThemeText(nowDark);
    localStorage.setItem("theme", nowDark ? "dark" : "light");
  }, 350);

  setTimeout(() => { dripContainer.classList.remove("active"); }, 700);
};

if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  updateThemeText(true);
} else {
  updateThemeText(false);
}

/* ===================== GRAMMAR EXAMPLES ===================== */
let grammarData = {};
fetch('grammar_examples.json').then(res => res.json()).then(data => {
    grammarData = data;
    document.querySelectorAll('.card-container').forEach(updateExample);
}).catch(err => console.error("Error loading examples:", err));

function updateExample(container) {
    const category = container.getAttribute('data-type');
    const exampleDiv = container.querySelector('.card-example');
    if (grammarData[category]) {
        const list = grammarData[category];
        const randomItem = list[Math.floor(Math.random() * list.length)];
        exampleDiv.textContent = `Halimbawa: ${randomItem}`;
    }
}

document.querySelectorAll('.card-container').forEach(container => {
    const card = container.querySelector('.card');
    container.addEventListener('click', () => {
        if (!card.classList.contains('is-flipped')) {
            card.classList.add('is-flipped');
            setTimeout(() => {
                card.classList.remove('is-flipped');
            }, 3000);
        }
    });
    card.addEventListener('transitionend', (e) => {
        if (e.propertyName === 'transform' && !card.classList.contains('is-flipped')) updateExample(container);
    });
});

window.onclick = (event) => { if (event.target == logoutModal) logoutModal.style.display = "none"; };
window.addEventListener("beforeunload", () => { if (studentUID) setStudentStatus(studentUID, "offline"); });
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard | UBigkas</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
  /* ===== DRIP EFFECT INTEGRATION ===== */
  #drip-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10000;
  }
  .drip-layer {
    position: absolute;
    top: -110%;
    left: 0;
    width: 100%;
    height: 120%;
    background-color: #181818;
    transition: top 0.7s cubic-bezier(0.645, 0.045, 0.355, 1);
    clip-path: url(#drip-path);
  }
  #drip-container.active .drip-layer {
    top: 0;
  }
  .drip-light { background-color: #fdfdfd !important; }

  /* ===== Logout & Dark Mode Button Styles ===== */
  .nav-actions {
    margin-left: auto;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #logoutBtn {
    padding: 10px 25px;
    border-radius: 25px;
    background-color: #d9534f;
    color: white;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  #logoutBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    background-color: #c9302c;
  }

  #darkModeBtn {
    padding: 10px 15px;
    border-radius: 25px;
    background-color: #333;
    color: #fff;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
  }

  #darkModeBtn:hover {
    background-color: #555;
  }

  /* ===== Dark Mode Styles ===== */
  body.dark-mode {
    background-color: #181818;
    color: #e6e6e6;
  }

  body.dark-mode nav {
    background-color: #202020;
  }

  body.dark-mode .dashboard-card,
  body.dark-mode .assessment-section,
  body.dark-mode .grammar-cards-section {
    background-color: #242424;
    color: #e6e6e6;
    border: 1px solid #333;
  }

  body.dark-mode .footer-credit {
    color: #999;
  }

  body.dark-mode a {
    color: #e6e6e6;
  }

  body.dark-mode button {
    background-color: #333;
    color: #e6e6e6;
  }

  body.dark-mode button:hover {
    background-color: #444;
  }

  /* ===== CUSTOM MODAL STYLES ===== */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
  }

  .modal-card {
    background: white;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .modal-actions {
    display: flex; gap: 15px; justify-content: center; margin-top: 20px;
  }

  .modal-btn {
    padding: 10px 25px; border-radius: 25px; border: none;
    font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;
  }

  .modal-btn.primary { background-color: #d9534f; color: white; }
  .modal-btn.secondary { background-color: #e9ecef; color: #333; }

  body.dark-mode .modal-card { background: #242424; color: #e6e6e6; border: 1px solid #333; }
  body.dark-mode .modal-btn.secondary { background-color: #333; color: #fff; }

  /* ===== GRAMMAR CARD FLIP LOGIC ===== */
  .grammar-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  .card-container {
    perspective: 1000px;
    cursor: pointer;
    height: 180px;
  }
  .card {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .card.is-flipped {
    transform: rotateY(180deg);
  }
  .card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 15px;
    padding: 15px;
  }
  .card-front {
    background-color: #7a0c0c;
    color: white;
    font-weight: 700;
  }
  .card-back {
    background-color: #fff;
    color: #333;
    transform: rotateY(180deg);
    border: 1px solid #ddd;
  }
  body.dark-mode .card-back {
    background-color: #333;
    color: #fff;
    border-color: #444;
  }
  .card-example {
    margin-top: 12px;
    font-style: italic;
    font-weight: 700;
    color: #d4af37;
    border-top: 1px dashed #ccc;
    padding-top: 8px;
    width: 90%;
    font-size: 0.9rem;
  }
  
  /* Feedback Styling */
  .feedback-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }
  body.dark-mode .feedback-item { border-bottom-color: #333; }
  .feedback-quiz-name { font-weight: 700; color: #7a0c0c; margin-right: 5px; }
  body.dark-mode .feedback-quiz-name { color: #d4af37; }
</style>

</head>
<body>

<div id="drip-container">
  <div id="dripLayer" class="drip-layer"></div>
  <svg width="0" height="0">
    <defs>
      <clipPath id="drip-path" clipPathUnits="objectBoundingBox">
        <path d="M0,0 L1,0 L1,0.8 C0.9,0.95 0.85,0.7 0.75,0.85 C0.65,1 0.55,0.75 0.5,0.9 C0.45,0.75 0.35,1 0.25,0.85 C0.15,0.7 0.1,0.95 0,0.8 Z"></path>
      </clipPath>
    </defs>
  </svg>
</div>

<nav>
  <a href="index.html" class="logo">UB<span>igkas</span></a>
  <ul>
    <li><a href="student_dashboard.html">Home</a></li>
    <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
    <li><a href="About.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>

  <div class="nav-actions">
    <button id="darkModeBtn">üåô</button>
    <button id="logoutBtn">Logout</button>
  </div>
</nav>

<div id="logoutModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Logout Confirmation</h3>
    <p>Are you sure you want to logout?</p>
    <div class="modal-actions">
      <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
      <button id="confirmLogout" class="modal-btn primary">Logout</button>
    </div>
  </div>
</div>

<div class="dashboard-container">
  <div class="dashboard-card full-width">
    <h1>Welcome, <span id="studentName"></span>!</h1>
    <p class="subtitle">Class Group: <span id="classId"></span></p>
    <button class="btn" id="quizBtn">Take Grammar Quiz</button>
  </div>

  <div class="assessment-section">
    <h3>Assessment Performance</h3>
    <canvas id="scoreChart" height="220"></canvas>
  </div>

  <div class="assessment-section" style="margin-top: 20px;">
      <h3>Personalized Feedback</h3>
      <div id="feedbackContainer" style="text-align: left; padding: 10px;">
          <p style="color: #888;">Complete a quiz to see your feedback here!</p>
      </div>
  </div>

  <div class="grammar-cards-section">
    <h3>Filipino Grammar Rules</h3>
    <div class="grammar-cards">
      <div class="card-container" data-type="Pangngalan">
        <div class="card">
          <div class="card-face card-front">Pangngalan</div>
          <div class="card-face card-back">
            Names a person, place, thing, or idea
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>

      <div class="card-container" data-type="Pandiwa">
        <div class="card">
          <div class="card-face card-front">Pandiwa</div>
          <div class="card-face card-back">
            Shows an action or state of being
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>

      <div class="card-container" data-type="Pang-uri">
        <div class="card">
          <div class="card-face card-front">Pang-uri</div>
          <div class="card-face card-back">
            Describes a noun
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>

      <div class="card-container" data-type="Pang-abay">
        <div class="card">
          <div class="card-face card-front">Pang-abay</div>
          <div class="card-face card-back">
            Modifies verbs, adjectives, or adverbs
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>

      <div class="card-container" data-type="Panghalip">
        <div class="card">
          <div class="card-face card-front">Panghalip</div>
          <div class="card-face card-back">
            Replaces a noun 
            <div class="card-example">Example: ...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-credit">
    ¬©2025 University of Batangas ‚Äì Lipa City
  </div>
</div>

<script type="module">
import { auth, db } from "../firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { collection, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const studentName = sessionStorage.getItem("studentName") || "Student";
const studentUID  = sessionStorage.getItem("studentUID");
const classId     = sessionStorage.getItem("classId");

document.getElementById("studentName").textContent = studentName;
document.getElementById("classId").textContent = classId;

/* ===================== FEEDBACK LOGIC ===================== */
const feedbackPool = {
    needsImprovement: [
        "It seems there is some confusion with {quiz}. Let's review the core rules and try again!",
        "Don't be discouraged! {quiz} can be tricky. A bit more practice will go a long way.",
        "Focus on the fundamental concepts of {quiz}. You've got this!",
        "Practice makes perfect. Re-reading the examples for {quiz} might help clarify things."
    ],
    proficient: [
        "Great job! You have a solid grasp of {quiz}, but there is still room for a perfect score.",
        "You're doing well with {quiz}. Just a few more exercises and you'll be an expert!",
        "Good progress on {quiz}! Keep up the consistent effort.",
        "Your understanding of {quiz} is clear. Aim for 100% on your next attempt!"
    ],
    advanced: [
        "Excellent! You have mastered {quiz} completely.",
        "Fantastic work! Your knowledge of {quiz} is impressive.",
        "Perfect or near-perfect! You are a pro at {quiz}.",
        "Outstanding performance! You clearly understand the nuances of {quiz}."
    ]
};

function formatQuizName(name) {
    const names = {
        vso: "Sentence Structure",
        pronouns: "Pronouns",
        affixes: "Verbs/Affixes",
        noun: "Nouns",
        adjective: "Adjectives",
        adverb: "Adverbs"
    };
    return names[name] || name;
}

function getFeedback(quizName, percentage) {
    let category = percentage < 75 ? "needsImprovement" : (percentage < 90 ? "proficient" : "advanced");
    const options = feedbackPool[category];
    const text = options[Math.floor(Math.random() * options.length)];
    return text.replace("{quiz}", formatQuizName(quizName));
}

/* ===================== DYNAMIC EXAMPLES LOGIC ===================== */
let grammarData = {};

fetch('grammar_examples.json')
  .then(res => res.json())
  .then(data => {
    grammarData = data;
    document.querySelectorAll('.card-container').forEach(updateExample);
  })
  .catch(err => console.error("Error loading examples:", err));

function updateExample(container) {
    const category = container.getAttribute('data-type');
    const exampleDiv = container.querySelector('.card-example');
    if (grammarData[category]) {
        const list = grammarData[category];
        const randomItem = list[Math.floor(Math.random() * list.length)];
        exampleDiv.textContent = `Halimbawa: ${randomItem}`;
    }
}

document.querySelectorAll('.card-container').forEach(container => {
    const card = container.querySelector('.card');

    container.addEventListener('click', () => {
        card.classList.toggle('is-flipped');
    });

    card.addEventListener('transitionend', (event) => {
        if (event.propertyName === 'transform') {
            if (!card.classList.contains('is-flipped')) {
                updateExample(container);
            }
        }
    });
});

/* ===================== REMAINING ORIGINAL LOGIC ===================== */
async function setStudentStatus(uid, status) {
  try {
    const studentRef = doc(db, "students", uid);
    await updateDoc(studentRef, { status: status, lastSeen: serverTimestamp() });
  } catch (err) { console.error("Status update failed:", err); }
}

onAuthStateChanged(auth, async user => {
  if (!user || !studentUID) { window.location.href = "../index.html"; }
  else { await setStudentStatus(studentUID, "online"); loadAssessmentScores(studentUID); }
});

document.getElementById("quizBtn").onclick = () => { window.location.href = "grammar_quiz.html"; };

const logoutBtn = document.getElementById("logoutBtn");
const logoutModal = document.getElementById("logoutModal");
const cancelLogout = document.getElementById("cancelLogout");
const confirmLogout = document.getElementById("confirmLogout");

logoutBtn.onclick = () => { logoutModal.style.display = "flex"; };
cancelLogout.onclick = () => { logoutModal.style.display = "none"; };

confirmLogout.onclick = async () => {
  if (studentUID) await setStudentStatus(studentUID, "offline");
  await signOut(auth);
  sessionStorage.clear();
  window.location.href = "../index.html";
};

window.onclick = (event) => {
  if (event.target == logoutModal) logoutModal.style.display = "none";
};

window.addEventListener("beforeunload", () => {
  if (studentUID) setStudentStatus(studentUID, "offline");
});

async function loadAssessmentScores(uid) {
  try {
    const ref = collection(db, "students", uid, "assessments");
    const snapshot = await getDocs(ref);
    const scoreMap = {};
    const feedbackContainer = document.getElementById("feedbackContainer");
    
    if (!snapshot.empty) feedbackContainer.innerHTML = "";

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const quiz = data.quizType || docSnap.id;
      const score = data.score ?? 0;
      const total = data.total ?? 1;
      const percentage = Math.round((score / total) * 100);

      if (!scoreMap[quiz] || score > scoreMap[quiz].score) { 
        scoreMap[quiz] = { score, total }; 
      }

      // Append Feedback
      const div = document.createElement("div");
      div.className = "feedback-item";
      div.innerHTML = `<span class="feedback-quiz-name">${formatQuizName(quiz)}:</span> ${getFeedback(quiz, percentage)}`;
      feedbackContainer.appendChild(div);
    });

    const labels = []; const values = [];
    for (const [quiz, val] of Object.entries(scoreMap)) {
      labels.push(quiz);
      values.push(Math.round((val.score / val.total) * 100));
    }
    if (labels.length) renderChart(labels, values);
  } catch (err) { console.error("Assessment load error:", err); }
}

function renderChart(labels, scores) {
  const ctx = document.getElementById("scoreChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{ data: scores, backgroundColor: "#7a0c0c", borderRadius: 10 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 0, max: 100, ticks: { callback: v => v + "%" }, grid: { color: "#444" } },
        x: { grid: { color: "#444" } }
      }
    }
  });
}

/* ===================== DRIP THEME SWITCHER ===================== */
const darkModeBtn = document.getElementById("darkModeBtn");
const dripContainer = document.getElementById("drip-container");
const dripLayer = document.getElementById("dripLayer");

darkModeBtn.onclick = () => {
  const isDark = document.body.classList.contains("dark-mode");
  
  if (isDark) {
    dripLayer.classList.add("drip-light");
  } else {
    dripLayer.classList.remove("drip-light");
  }

  dripContainer.classList.add("active");

  setTimeout(() => {
    document.body.classList.toggle("dark-mode");
    const nowDark = document.body.classList.contains("dark-mode");
    darkModeBtn.textContent = nowDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", nowDark ? "dark" : "light");
  }, 350);

  setTimeout(() => {
    dripContainer.classList.remove("active");
  }, 700);
};

if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  darkModeBtn.textContent = "‚òÄÔ∏è";
}
</script>

</body>
</html>
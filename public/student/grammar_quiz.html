<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Filipino Grammar Quiz | UBigkas</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="grammar_quiz.css">

<style>
/* ===== DRIP EFFECT INTEGRATION ===== */
#drip-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10000;
}
.drip-layer {
    position: absolute;
    top: -110%;
    left: 0;
    width: 100%;
    height: 120%;
    background-color: #181818;
    transition: top 0.7s cubic-bezier(0.645, 0.045, 0.355, 1);
    clip-path: url(#drip-path);
}
#drip-container.active .drip-layer {
    top: 0;
}
.drip-light { background-color: #f8f9fa !important; }

.quiz-instruction {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 12px;
    font-weight: 500;
}

/* ===== MOBILE RESPONSIVE STYLES ===== */
/* Mobile Navigation */
.menu-toggle {
    display: none;
    flex-direction: column;
    justify-content: space-between;
    width: 30px;
    height: 21px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 1001;
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
}

.menu-toggle span {
    display: block;
    width: 100%;
    height: 3px;
    background-color: maroon;
    border-radius: 3px;
    transition: all 0.3s ease;
}

.menu-toggle.active span:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
}

.menu-toggle.active span:nth-child(2) {
    opacity: 0;
}

.menu-toggle.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
}

.mobile-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.mobile-overlay.active {
    display: block;
    opacity: 1;
}

.mobile-nav {
    position: fixed;
    top: 0;
    left: -280px;
    width: 280px;
    height: 100%;
    background-color: #fff;
    z-index: 1000;
    transition: left 0.3s ease;
    padding: 80px 20px 20px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.mobile-nav.active {
    left: 0;
}

.mobile-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
}

.mobile-nav ul li {
    margin-bottom: 15px;
    text-align: center;
}

.mobile-nav ul li a {
    display: block;
    padding: 15px;
    text-decoration: none;
    color: #333;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 1.1rem;
}

.mobile-nav ul li a:hover {
    background-color: #f5f5f5;
    color: maroon;
}

.mobile-nav-actions {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
}

.mobile-nav-actions button {
    width: 100%;
    padding: 14px;
    border-radius: 25px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    font-size: 1rem;
}

/* Dark mode styles for mobile nav */
body.dark-mode .mobile-nav {
    background-color: #202020;
}

body.dark-mode .mobile-nav ul li a {
    color: #fff;
}

body.dark-mode .mobile-nav ul li a:hover {
    background-color: #333;
    color: #d4af37;
}

body.dark-mode .menu-toggle span {
    background-color: #fff;
}

/* ===== NAV & ACTIONS ===== */
nav {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    position: relative;
    z-index: 100;
    height: 70px;
}
nav .logo {
    font-weight: 700;
    font-size: 22px;
    text-decoration: none;
    color: maroon;
    flex-shrink: 0;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}
nav .logo span { color: #d4af37; }
nav ul { 
    list-style: none; 
    display: flex; 
    gap: 15px; 
    margin-left: 20px;
}
nav ul li a { 
    text-decoration: none; 
    font-weight: 500; 
    color: #000000 !important; 
    transition: color 0.3s ease; 
    white-space: nowrap;
}
nav ul li a:hover { color: maroon !important; }

.nav-actions { 
    margin-left: auto; 
    display: flex; 
    flex-direction: row; 
    gap: 10px; 
    align-items: center;
    flex-shrink: 0;
}
#logoutBtn, #musicToggle, #darkModeBtn {
    padding: 8px 20px;
    border-radius: 25px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    white-space: nowrap;
}
#logoutBtn { background-color: #d9534f; color: white; }
#darkModeBtn { background-color: #333; color: #fff; }
#musicToggle { background: #d4af37; color: #7a0c0c; }

/* ===== DARK MODE STYLES ===== */
body.dark-mode { background-color: #181818; color: #e6e6e6; }
body.dark-mode nav { background-color: #202020; }
body.dark-mode nav ul li a,
body.dark-mode nav .logo {
    color: #ffffff !important;
}
body.dark-mode nav ul li a:hover,
body.dark-mode nav .logo:hover {
    color: #d4af37 !important;
}
body.dark-mode .dashboard-card, 
body.dark-mode .modal-content { 
    background-color: #242424; 
    color: #e6e6e6; 
    border: 1px solid #333; 
}
body.dark-mode .modal-card { background-color: #242424; color: #fff; border: 1px solid #444; }
body.dark-mode .modal-card h3 { color: #fff; }
body.dark-mode .modal-card p { color: #ccc; }
body.dark-mode .modal-btn.secondary { background-color: #444; color: #eee; }

/* ===== QUIZ MODAL ===== */
.modal {
    display: none; position: fixed; z-index: 2500; left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
}
.modal-content {
    background: #ffffff; margin: 2% auto -5% auto; padding: 40px; border-radius: 25px;
    max-width: 650px; width: 90%; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    max-height: 85vh; overflow-y: auto; scrollbar-width: thin;
}
.modal-content::-webkit-scrollbar {
    width: 8px;
}
.modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}
.modal-content::-webkit-scrollbar-thumb {
    background: #d4af37;
    border-radius: 10px;
}
.modal-content::-webkit-scrollbar-thumb:hover {
    background: #b38f00;
}
body.dark-mode .modal-content {
    background: #242424;
    color: #e6e6e6;
}
body.dark-mode .modal-content::-webkit-scrollbar-track {
    background: #333;
}
body.dark-mode .modal-content::-webkit-scrollbar-thumb {
    background: #d4af37;
}

#qProgress {
    font-weight: 700; color: #d4af37; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; margin-bottom: 5px;
}
.sentence {
    font-size: 1.4rem; font-weight: 600; color: #2c3e50; line-height: 1.4; margin-bottom: 25px;
}
body.dark-mode .sentence { color: #fff; }

.options { display: grid; grid-template-columns: 1fr; gap: 12px; }
.options button {
    padding: 15px 20px; font-size: 1rem; border: 2px solid #e9ecef; border-radius: 12px;
    background: #f8f9fa; color: #333; text-align: left; font-weight: 500; transition: all 0.2s ease; cursor: pointer; font-family: 'Poppins', sans-serif;
}
.options button:hover { border-color: #d4af37; background-color: #fffdf5; }
.options button.correct { background-color: #2ecc71 !important; color: white !important; border-color: #27ae60 !important; }
.options button.wrong { background-color: #e74c3c !important; color: white !important; border-color: #c0392b !important; }

.explanation {
    margin-top: 25px; padding: 15px; background-color: #e8f4fd; color: #2980b9;
    border-radius: 12px; font-size: 0.9rem; border-left: 5px solid #3498db; display: none;
}
body.dark-mode .explanation { background-color: #1a2633; color: #5dade2; }

.score-area {
    margin-top: 30px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #f1f1f1; padding-top: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
.modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
.modal-btn { padding: 10px 25px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; }
.modal-btn.primary { background-color: #d9534f; color: white; }
.modal-btn.secondary { background-color: #e9ecef; color: #333; }

/* ===== SCORE MODAL & CONFETTI ===== */
#scoreResultModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; }
.score-card { background: white; padding: 40px; border-radius: 30px; text-align: center; max-width: 450px; width: 90%; position: relative; z-index: 5002; }
.score-number { font-size: 3.5rem; font-weight: 700; margin: 15px 0; color: maroon; }
.score-feedback { font-size: 1.1rem; color: #444; font-weight: 500; margin-bottom: 25px; line-height: 1.5; min-height: 3em; display: flex; align-items: center; justify-content: center;}
body.dark-mode .score-card { background: #242424; color: #fff; }
body.dark-mode .score-feedback { color: #ccc; }

#confetti-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5001;
    overflow: hidden;
}

.confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    top: -20px;
    border-radius: 2px;
    animation: fall 3s linear forwards;
}

@keyframes fall {
    to {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
    }
}

/* Camera shake (only on wrong answer) */
.camera-shake {
    animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
}

@keyframes shake {
    10%, 90% { transform: translate3d(-3px, 0, 0); }
    20%, 80% { transform: translate3d(5px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
    40%, 60% { transform: translate3d(8px, 0, 0); }
}

/* ===== DASHBOARD CONTAINER ===== */
.dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.back-nav {
    margin-bottom: 20px;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: maroon;
    font-weight: 500;
    padding: 8px 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.back-link:hover {
    background-color: #f5f5f5;
}

.dashboard-card {
    background: #fff;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.dashboard-card h1 {
    font-size: 2rem;
    color: maroon;
    margin-bottom: 10px;
}

.subtitle {
    color: #666;
    margin-bottom: 30px;
    font-size: 1.1rem;
}

.test-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 15px 25px;
    background: maroon;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
}

.btn:hover {
    background: #7a0c0c;
    transform: translateY(-2px);
}

.footer-credit {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 0.9rem;
    margin-top: 40px;
}

/* ===== RESPONSIVE MEDIA QUERIES ===== */
@media screen and (max-width: 992px) {
    .dashboard-card h1 {
        font-size: 1.8rem;
    }
    
    .test-buttons {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media screen and (max-width: 768px) {
    /* MOBILE NAVIGATION LAYOUT */
    nav {
        position: relative;
        height: 70px;
        padding: 0 20px;
    }
    
    /* Hide desktop nav and show mobile toggle */
    nav ul, .nav-actions {
        display: none;
    }
    
    /* Burger button on left side */
    .menu-toggle {
        display: flex;
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
    }
    
    /* UBigkas logo in middle */
    nav .logo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        margin: 0;
    }
    
    .dashboard-container {
        padding: 15px;
    }
    
    .dashboard-card {
        padding: 20px;
    }
    
    .dashboard-card h1 {
        font-size: 1.6rem;
    }
    
    .subtitle {
        font-size: 1rem;
    }
    
    .test-buttons {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 0.95rem;
    }
    
    /* Quiz modal adjustments */
    .modal-content {
        padding: 25px 20px;
        margin: 5% auto;
        width: 95%;
        max-height: 90vh;
    }
    
    .sentence {
        font-size: 1.2rem;
        line-height: 1.3;
    }
    
    .options button {
        padding: 14px 16px;
        font-size: 0.95rem;
    }
    
    .score-area {
        flex-direction: column;
        align-items: stretch;
    }
    
    .score-area .btn {
        max-width: 100%;
        width: 100%;
    }
    
    /* Score modal adjustments */
    .score-card {
        padding: 30px 20px;
        width: 95%;
    }
    
    .score-number {
        font-size: 2.8rem;
    }
    
    .footer-credit {
        padding: 15px;
        font-size: 0.85rem;
    }
}

@media screen and (max-width: 480px) {
    nav {
        padding: 0 15px;
        height: 60px;
    }
    
    .logo {
        font-size: 20px;
    }
    
    .menu-toggle {
        left: 15px;
    }
    
    .dashboard-card h1 {
        font-size: 1.4rem;
    }
    
    .subtitle {
        font-size: 0.95rem;
    }
    
    .modal-content {
        padding: 20px 15px;
    }
    
    .sentence {
        font-size: 1.1rem;
    }
    
    .options button {
        padding: 12px 14px;
        font-size: 0.9rem;
    }
    
    .score-number {
        font-size: 2.5rem;
    }
    
    .score-feedback {
        font-size: 1rem;
    }
}

/* Small height devices */
@media screen and (max-height: 600px) {
    .modal-content {
        margin: 2% auto;
        max-height: 96vh;
    }
    
    .sentence {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    
    .options button {
        padding: 10px 15px;
    }
}
</style>
</head>

<body>

<div id="drip-container">
  <div id="dripLayer" class="drip-layer"></div>
  <svg width="0" height="0">
    <defs>
      <clipPath id="drip-path" clipPathUnits="objectBoundingBox">
        <path d="M0,0 L1,0 L1,0.8 C0.9,0.95 0.85,0.7 0.75,0.85 C0.65,1 0.55,0.75 0.5,0.9 C0.45,0.75 0.35,1 0.25,0.85 C0.15,0.7 0.1,0.95 0,0.8 Z"></path>
      </clipPath>
    </defs>
  </svg>
</div>

<!-- Mobile Navigation Elements -->
<button class="menu-toggle" id="menuToggle">
    <span></span>
    <span></span>
    <span></span>
</button>

<div class="mobile-overlay" id="mobileOverlay"></div>

<div class="mobile-nav" id="mobileNav">
    <ul>
        <li><a href="student_dashboard.html">Home</a></li>
        <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
        <li><a href="About.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
    </ul>
    <div class="mobile-nav-actions">
        <button id="mobileDarkModeBtn">ðŸŒ™ Dark Mode</button>
        <button id="mobileLogoutBtn">Logout</button>
        <button id="mobileMusicToggle">Mute Music</button>
    </div>
</div>

<div id="toast-container"></div>

<div id="scoreResultModal">
    <div id="confetti-wrapper"></div>
    <div class="score-card">
        <!-- Brahmmy shows medal when passed, sad when failed -->
        <img id="brahmmyResult" src="" alt="" style="display: none; margin: 0 auto 20px auto; width:220px;">
        <h2>Quiz Complete!</h2>
        <p>Iyong nakuha ay:</p>
        <div class="score-number" id="finalScoreDisplay">0/10</div>
        <p class="score-feedback" id="feedbackMessage"></p>
        <button class="modal-btn primary" id="continueBtn" style="width: 100%;">Mahusay!</button>
    </div>
</div>

<nav>
  <a href="index.html" class="logo">UB<span>igkas</span></a>
  <ul id="desktopNav">
    <li><a href="student_dashboard.html">Home</a></li>
    <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
    <li><a href="About.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>
  <div class="nav-actions" id="desktopActions">
    <button id="darkModeBtn">ðŸŒ™</button>
    <button id="logoutBtn">Logout</button>
    <button id="musicToggle">Mute Music</button>
  </div>
</nav>

<div id="logoutModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Logout Confirmation</h3>
    <p>Are you sure you want to logout?</p>
    <div class="modal-actions">
      <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
      <button id="confirmLogout" class="modal-btn primary">Logout</button>
    </div>
  </div>
</div>

<audio id="bgMusic" src="assessment/music/Quiz.mp3" loop autoplay></audio>

<div class="dashboard-container">
    <div class="back-nav">
        <a href="student_dashboard.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <div class="dashboard-card">
        <h1>Filipino Grammar Quiz</h1>
        <p class="subtitle">Subukan ang iyong galing sa balarilang Filipino.</p>

        <div class="test-buttons">
            <button class="btn" data-file="vso">Sentence Structure</button>
            <button class="btn" data-file="pronouns">Pronouns (Panghalip)</button>
            <button class="btn" data-file="affixes">Verbs (Pandiwa)</button>
            <button class="btn" data-file="noun">Noun (Pangalan)</button>
            <button class="btn" data-file="adjective">Adjective (Panguri)</button>
            <button class="btn" data-file="adverb">Adverb (Pangabay)</button>
        </div>
    </div>
</div>

<div id="quizModal" class="modal">
    <div class="modal-content" id="quizContent">
        <button class="close-btn" id="closeModalBtn">Ã—</button>
        <div id="qProgress">Question 1 of 10</div>
        <p class="quiz-instruction" id="quizInstruction"></p>
        <p class="sentence" id="sentence"></p>
        <div class="options" id="options"></div>
        <div class="explanation" id="explanation"></div>

        <div class="score-area">
            <p class="score-text" id="score">Score: 0</p>
            <button class="btn" id="nextBtn" style="max-width:180px;background:#d4af37;color:white;border:none;border-radius:10px;padding:12px 25px;">
                Next Question
            </button>
        </div>
    </div>
</div>

<div class="footer-credit">Â©2025 University of Batangas â€“ Lipa City</div>

<script type="module">
import { auth, db } from "../firebase.js";
import { signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let studentName = sessionStorage.getItem("studentName");
let studentUID  = sessionStorage.getItem("studentUID");
let classId     = sessionStorage.getItem("classId");

if (!studentName || !studentUID) { window.location.href = "../index.html"; }

function showToast(message) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
}

// FIXED: Score modal button handler
document.getElementById("continueBtn").onclick = function() {
    document.getElementById("scoreResultModal").style.display = "none";
    document.getElementById("confetti-wrapper").innerHTML = "";
};

async function getRandomFeedback(score, total) {
    try {
        const res = await fetch('assessment/feedback.json');
        const feedbackData = await res.json();
        const percent = (score / total) * 100;
        
        let pool = [];
        if (percent === 100) pool = feedbackData.excellent;
        else if (percent >= 80) pool = feedbackData.great;
        else if (percent >= 50) pool = feedbackData.good;
        else pool = feedbackData.keep_trying;

        const randomIndex = Math.floor(Math.random() * pool.length);
        return pool[randomIndex];
    } catch (err) {
        console.error("Feedback fetch error:", err);
        return "Mahusay!"; 
    }
}

async function triggerScoreModal(finalScore, total) {
    const modal = document.getElementById("scoreResultModal");
    const scoreDisplay = document.getElementById("finalScoreDisplay");
    const feedbackEl = document.getElementById("feedbackMessage");
    const confettiWrapper = document.getElementById("confetti-wrapper");
    const brahmmyResult = document.getElementById("brahmmyResult");
    const continueBtn = document.getElementById("continueBtn");
    
    scoreDisplay.textContent = `${finalScore}/${total}`;
    feedbackEl.textContent = await getRandomFeedback(finalScore, total);
    
    // Show Brahmmy medal when passed (â‰¥ 50%), sad Brahmmy when failed
    if ((finalScore / total) >= 0.5) {
        brahmmyResult.src = "../brahmmy-img/BRAHMMY_MEDAL.PNG";
        brahmmyResult.style.display = "block";
        continueBtn.textContent = "Mahusay!";
    } else {
        brahmmyResult.src = "../brahmmy-img/brahmmy-sad.png";
        brahmmyResult.style.display = "block";
        continueBtn.textContent = "Continue";
    }
    
    modal.style.display = "flex";
    confettiWrapper.innerHTML = "";
    
    // Only show confetti when passed (â‰¥ 50%)
    if ((finalScore / total) >= 0.5) {
        const colors = ['#d4af37', '#7a0c0c', '#ffffff', '#ff0000', '#ffd700'];
        for(let i=0; i<100; i++) {
            const confetti = document.createElement("div");
            confetti.className = "confetti";
            confetti.style.left = Math.random() * 100 + "vw";
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + "s";
            confetti.style.width = Math.random() * 8 + 5 + "px";
            confetti.style.height = confetti.style.width;
            confettiWrapper.appendChild(confetti);
        }
    }
}

let questions = [];
let score = 0;
let currentQuiz = "";
let currentQuestionIndex = 0;
let answered = false;

const modal = document.getElementById("quizModal");
const sentenceEl = document.getElementById("sentence");
const optionsEl = document.getElementById("options");
const explanationEl = document.getElementById("explanation");
const nextBtn = document.getElementById("nextBtn");
const scoreEl = document.getElementById("score");
const instructionEl = document.getElementById("quizInstruction");
const progressEl = document.getElementById("qProgress");
const quizContent = document.getElementById("quizContent");

/* ========== QUIZ CONFIGURATION ========== */
/* Only 3 JSON files available */
const quizPaths = {
    vso: "assessment/sentence_structure.json",
    pronouns: "assessment/pronoun_questions.json",
    affixes: "assessment/affix_questions.json"
};

/* Instructions for all 6 buttons */
const quizInstructions = {
    vso: "Panuto: Piliin ang tamang ayos ng pangungusap (Verbâ€“Subjectâ€“Object).",
    pronouns: "Panuto: Piliin ang tamang panghalip na angkop sa pangungusap.",
    affixes: "Panuto: Piliin ang tamang pandiwa ayon sa aspekto o panlapi.",
    noun: "Panuto: Piliin ang tamang pangngalan na angkop sa pangungusap.",
    adjective: "Panuto: Piliin ang tamang pang-uri na angkop sa pangungusap.",
    adverb: "Panuto: Piliin ang tamang pang-abay na angkop sa pangungusap."
};

/* Button mapping: Last 4 buttons use the same "affixes" JSON file */
const buttonMapping = {
    "vso": "vso",
    "pronouns": "pronouns", 
    "affixes": "affixes",      // Verbs (Pandiwa) button
    "noun": "affixes",         // Noun button uses affixes file
    "adjective": "affixes",    // Adjective button uses affixes file
    "adverb": "affixes"        // Adverb button uses affixes file
};

/* ========== START QUIZ ========== */
document.querySelectorAll(".test-buttons button").forEach(btn => {
    btn.addEventListener("click", function() {
        const buttonType = this.getAttribute("data-file");
        const quizFile = buttonMapping[buttonType];
        
        // Show appropriate instruction for the clicked button
        instructionEl.textContent = quizInstructions[buttonType];
        
        startQuiz(quizFile);
    });
});

function startQuiz(quizName) {
    console.log("Starting quiz:", quizName);
    
    if (!quizPaths[quizName]) {
        console.error("Quiz path not found:", quizName);
        showToast(`Error: Quiz configuration not found.`);
        return;
    }
    
    score = 0;
    currentQuestionIndex = 0;
    currentQuiz = quizName;
    scoreEl.textContent = "Score: 0";
    
    fetch(quizPaths[quizName])
        .then(res => {
            if (!res.ok) {
                throw new Error(`Failed to load quiz file: ${res.status} ${res.statusText}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data || !Array.isArray(data) || data.length === 0) {
                throw new Error("Quiz data is empty or not an array");
            }
            
            questions = data.sort(() => 0.5 - Math.random()).slice(0, 10);
            modal.style.display = "block";
            loadQuestion();
        })
        .catch(err => {
            console.error("Error loading quiz questions:", err);
            showToast(`Error loading quiz. Please check if the JSON files exist.`);
        });
}

function loadQuestion() {
    if (currentQuestionIndex >= questions.length) {
        saveScore();
        modal.style.display = "none";
        triggerScoreModal(score, questions.length);
        return;
    }

    answered = false;
    nextBtn.disabled = true;
    nextBtn.style.opacity = "0.5";
    progressEl.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;

    const q = questions[currentQuestionIndex];
    sentenceEl.textContent = q.wrongSentence;
    optionsEl.innerHTML = "";
    explanationEl.style.display = "none";

    // Check if options exist
    if (!q.options || q.options.length === 0) {
        console.error("No options available for question:", q);
        showToast("Error: No options available for this question.");
        return;
    }

    q.options.sort(() => 0.5 - Math.random()).forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.onclick = () => {
            if (answered) return;
            answered = true;
            nextBtn.disabled = false;
            nextBtn.style.opacity = "1";

            if (option === q.correctOption) {
                btn.classList.add("correct");
                score++;
                // Right answer: confetti
                triggerConfetti();
            } else {
                btn.classList.add("wrong");
                // Highlight correct answer
                Array.from(optionsEl.children).forEach(child => {
                    if (child.textContent === q.correctOption) {
                        child.classList.add("correct");
                    }
                });
                // Wrong answer: camera shake
                quizContent.classList.add("camera-shake");
                setTimeout(() => quizContent.classList.remove("camera-shake"), 600);
            }

            explanationEl.textContent = q.explanation;
            explanationEl.style.display = "block";
            scoreEl.textContent = `Score: ${score}`;
        };
        optionsEl.appendChild(btn);
    });
}

function triggerConfetti() {
    const wrapper = document.getElementById("confetti-wrapper") || document.createElement("div");
    if (!document.getElementById("confetti-wrapper")) {
        wrapper.id = "confetti-wrapper";
        wrapper.style.cssText = "position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden;";
        document.body.appendChild(wrapper);
    }

    const colors = ['#d4af37', '#7a0c0c', '#ffffff', '#ff0000', '#ffd700'];
    for(let i = 0; i < 30; i++) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.left = Math.random() * 100 + "vw";
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + "s";
        confetti.style.width = Math.random() * 8 + 5 + "px";
        confetti.style.height = confetti.style.width;
        wrapper.appendChild(confetti);
    }

    setTimeout(() => {
        wrapper.innerHTML = "";
    }, 3000);
}

nextBtn.addEventListener("click", () => {
    currentQuestionIndex++;
    loadQuestion();
});

document.getElementById("closeModalBtn").addEventListener("click", () => {
    modal.style.display = "none";
});

async function saveScore() {
    if (!studentUID || !classId) {
        console.error("Missing student UID or class ID");
        return;
    }

    const timestamp = new Date().toISOString().split('T')[0];
    const quizType = currentQuiz.charAt(0).toUpperCase() + currentQuiz.slice(1);
    const docRef = doc(db, "students", studentUID, "scores", `quiz_${Date.now()}`);
    
    try {
        await setDoc(docRef, {
            studentName: studentName,
            studentUID: studentUID,
            classId: classId,
            quizType: quizType,
            score: score,
            total: questions.length,
            percentage: Math.round((score / questions.length) * 100),
            timestamp: serverTimestamp(),
            date: timestamp
        });
        
        // Update dashboard stats
        const statsRef = doc(db, "students", studentUID);
        await updateDoc(statsRef, {
            lastActivity: serverTimestamp(),
            lastQuizTaken: quizType,
            lastQuizScore: score + "/" + questions.length
        });
        
        console.log("Score saved successfully!");
    } catch (error) {
        console.error("Error saving score:", error);
        showToast("Error saving score. Please check your connection.");
    }
}

// ===== MOBILE NAVIGATION =====
const menuToggle = document.getElementById("menuToggle");
const mobileOverlay = document.getElementById("mobileOverlay");
const mobileNav = document.getElementById("mobileNav");

menuToggle.addEventListener("click", () => {
    menuToggle.classList.toggle("active");
    mobileNav.classList.toggle("active");
    mobileOverlay.classList.toggle("active");
});

mobileOverlay.addEventListener("click", () => {
    menuToggle.classList.remove("active");
    mobileNav.classList.remove("active");
    mobileOverlay.classList.remove("active");
});

// Mobile Action Buttons
document.getElementById("mobileDarkModeBtn").addEventListener("click", () => {
    document.getElementById("darkModeBtn").click();
});

document.getElementById("mobileLogoutBtn").addEventListener("click", () => {
    document.getElementById("logoutBtn").click();
});

document.getElementById("mobileMusicToggle").addEventListener("click", () => {
    document.getElementById("musicToggle").click();
});

// ===== DARK MODE TOGGLE =====
const darkModeBtn = document.getElementById("darkModeBtn");
const storedTheme = localStorage.getItem("theme") || "light";

if (storedTheme === "dark") {
    document.body.classList.add("dark-mode");
    darkModeBtn.textContent = "â˜€ï¸";
}

darkModeBtn.addEventListener("click", () => {
    const isDark = document.body.classList.toggle("dark-mode");
    darkModeBtn.textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
    localStorage.setItem("theme", isDark ? "dark" : "light");
    
    // Update mobile button text
    document.getElementById("mobileDarkModeBtn").textContent = 
        isDark ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
});

// ===== MUSIC TOGGLE =====
const musicToggle = document.getElementById("musicToggle");
const bgMusic = document.getElementById("bgMusic");
let isMuted = localStorage.getItem("musicMuted") === "true";

if (isMuted) {
    bgMusic.muted = true;
    musicToggle.textContent = "ðŸ”‡ Unmute Music";
}

musicToggle.addEventListener("click", () => {
    isMuted = !isMuted;
    bgMusic.muted = isMuted;
    musicToggle.textContent = isMuted ? "ðŸ”‡ Unmute Music" : "ðŸ”Š Mute Music";
    localStorage.setItem("musicMuted", isMuted);
});

// ===== LOGOUT FUNCTIONALITY =====
const logoutModal = document.getElementById("logoutModal");
const confirmLogout = document.getElementById("confirmLogout");
const cancelLogout = document.getElementById("cancelLogout");

document.getElementById("logoutBtn").addEventListener("click", () => {
    logoutModal.style.display = "flex";
});

cancelLogout.addEventListener("click", () => {
    logoutModal.style.display = "none";
});

confirmLogout.addEventListener("click", async () => {
    try {
        await signOut(auth);
        sessionStorage.clear();
        localStorage.removeItem("theme");
        localStorage.removeItem("musicMuted");
        
        // Trigger drip transition
        const dripContainer = document.getElementById("drip-container");
        const dripLayer = document.getElementById("dripLayer");
        dripContainer.classList.add("active");
        
        // Add appropriate class based on current theme
        const isDark = document.body.classList.contains("dark-mode");
        if (isDark) {
            dripLayer.classList.remove("drip-light");
        } else {
            dripLayer.classList.add("drip-light");
        }
        
        setTimeout(() => {
            window.location.href = "../index.html";
        }, 700);
        
    } catch (error) {
        console.error("Logout error:", error);
        showToast("Logout failed. Please try again.");
    }
});

// ===== MODAL CLOSING =====
window.addEventListener("click", (e) => {
    if (e.target === modal) {
        modal.style.display = "none";
    }
    if (e.target === logoutModal) {
        logoutModal.style.display = "none";
    }
    if (e.target === document.getElementById("scoreResultModal")) {
        document.getElementById("scoreResultModal").style.display = "none";
        document.getElementById("confetti-wrapper").innerHTML = "";
    }
});

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener("keydown", (e) => {
    // Close modals with Escape
    if (e.key === "Escape") {
        modal.style.display = "none";
        logoutModal.style.display = "none";
        document.getElementById("scoreResultModal").style.display = "none";
    }
    
    // Next question with Enter (when next button is enabled)
    if (e.key === "Enter" && !nextBtn.disabled && modal.style.display === "block") {
        nextBtn.click();
    }
});

// ===== INITIALIZE MOBILE BUTTONS =====
document.addEventListener("DOMContentLoaded", () => {
    const isDark = document.body.classList.contains("dark-mode");
    document.getElementById("mobileDarkModeBtn").textContent = 
        isDark ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
    
    const isMutedInit = localStorage.getItem("musicMuted") === "true";
    document.getElementById("mobileMusicToggle").textContent = 
        isMutedInit ? "ðŸ”‡ Unmute Music" : "ðŸ”Š Mute Music";
});

// ===== MOBILE AUTOPLAY FIX =====
document.addEventListener('touchstart', function() {
    const bgMusic = document.getElementById('bgMusic');
    if (bgMusic.paused) {
        bgMusic.play().catch(e => console.log("Autoplay prevented:", e));
    }
}, { once: true });
</script>
</body>
</html>
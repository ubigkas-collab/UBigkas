<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Filipino Grammar Quiz | UBigkas</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="grammar_quiz.css">

<style>
/* ===== DRIP EFFECT INTEGRATION ===== */
#drip-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10000;
}
.drip-layer {
    position: absolute;
    top: -110%;
    left: 0;
    width: 100%;
    height: 120%;
    background-color: #181818;
    transition: top 0.7s cubic-bezier(0.645, 0.045, 0.355, 1);
    clip-path: url(#drip-path);
}
#drip-container.active .drip-layer {
    top: 0;
}
.drip-light { background-color: #f8f9fa !important; }

.quiz-instruction {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 12px;
    font-weight: 500;
}

/* ===== Nav & Actions ===== */
nav {
    display: flex;
    align-items: center;
    padding: 0 5%;
    height: 80px;
    background-color: #fff;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
}

nav .logo {
    font-weight: 800;
    font-size: 1.8rem;
    text-decoration: none;
    color: maroon;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}
nav .logo span { color: #d4af37; }

/* ===== BURGER MENU BUTTON ===== */
.burger-menu {
    display: none;
    flex-direction: column;
    gap: 5px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 10px;
    z-index: 1002;
    position: relative;
    top: 5px; /* Moved down a bit */
}
.burger-menu span {
    width: 25px;
    height: 3px;
    background-color: maroon;
    border-radius: 2px;
    transition: 0.3s;
}

nav ul { 
    list-style: none; 
    display: flex; 
    gap: 30px;
    margin: 0;
    padding: 0;
}
nav ul li a { 
    text-decoration: none; 
    font-weight: 500; 
    color: #000000 !important; 
    transition: color 0.3s ease; 
    white-space: nowrap;
}
nav ul li a:hover { color: maroon !important; }

.nav-actions { 
    margin-left: auto; 
    display: flex; 
    flex-direction: row; 
    gap: 10px; 
    align-items: center;
    flex-shrink: 0;
}

#logoutBtn, #musicToggle, #darkModeBtn {
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    white-space: nowrap;
}
#logoutBtn { 
    background-color: #333; 
    color: white; 
}
#logoutBtn:hover {
    background-color: #444;
}
#darkModeBtn { 
    background-color: #333; 
    color: #fff; 
}
#darkModeBtn:hover {
    background-color: #444;
}
#musicToggle { 
    background: #d4af37; 
    color: maroon; 
    font-weight: 600;
}
#musicToggle:hover {
    background: #b38f00;
}

/* ===== DARK MODE STYLES ===== */
body.dark-mode { 
    background-color: #181818; 
    color: #e6e6e6; 
}
body.dark-mode nav { 
    background-color: #202020; 
}

/* Nav links and UB logo text color in dark mode */
body.dark-mode nav ul li a,
body.dark-mode nav .logo {
    color: #ffffff !important;
}

/* Gold hover effect for Nav and Logo in dark mode */
body.dark-mode nav ul li a:hover,
body.dark-mode nav .logo:hover {
    color: #d4af37 !important;
}

body.dark-mode .dashboard-card, 
body.dark-mode .modal-content { 
    background-color: #242424; 
    color: #e6e6e6; 
    border: 1px solid #333; 
}

body.dark-mode .burger-menu span { 
    background-color: #ffffff; 
}

/* FIX: Dark Mode for Logout Modal */
body.dark-mode .modal-card { 
    background-color: #242424; 
    color: #fff; 
    border: 1px solid #444; 
}
body.dark-mode .modal-card h3 { 
    color: #fff; 
}
body.dark-mode .modal-card p { 
    color: #ccc; 
}
body.dark-mode .modal-btn.secondary { 
    background-color: #444; 
    color: #eee; 
}

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 850px) {
    nav {
        height: 70px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0 20px;
    }

    .burger-menu {
        display: flex;
        grid-column: 1;
        justify-self: start;
        align-self: center;
    }

    nav .logo {
        position: relative;
        left: 0;
        transform: none;
        grid-column: 2;
        justify-self: center;
        font-size: 1.5rem;
    }

    .nav-actions {
        grid-column: 3;
        justify-self: end;
    }

    /* Side Panel Navigation */
    nav ul {
        position: fixed;
        top: 0;
        left: -100%; /* Fully hidden */
        width: 280px;
        height: 100vh;
        background-color: #ffffff;
        flex-direction: column;
        padding: 100px 30px 30px 30px;
        gap: 25px;
        box-shadow: 10px 0 20px rgba(0,0,0,0.1);
        transition: left 0.4s cubic-bezier(0.77, 0, 0.175, 1);
        z-index: 1001;
    }

    nav ul.show {
        left: 0;
    }

    nav ul li a {
        font-size: 1.2rem;
        display: block;
        width: 100%;
        color: #000000 !important;
    }

    nav ul li a:hover {
        color: maroon !important;
    }

    body.dark-mode nav ul {
        background-color: #202020;
        box-shadow: 10px 0 20px rgba(0,0,0,0.4);
    }

    body.dark-mode nav ul li a {
        color: #ffffff !important;
    }

    body.dark-mode nav ul li a:hover {
        color: #d4af37 !important;
    }

    /* Adjust button sizes for mobile */
    #logoutBtn, #musicToggle, #darkModeBtn {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
}

/* ===== QUIZ MODAL REFINEMENTS ===== */
.modal {
    display: none; position: fixed; z-index: 2500; left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
}
.modal-content {
    background: #ffffff; margin: 2% auto; padding: 40px; border-radius: 25px;
    max-width: 650px; width: 90%; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    max-height: 85vh; overflow-y: auto; scrollbar-width: thin;
}

/* Custom scrollbar for Chrome/Edge/Safari */
.modal-content::-webkit-scrollbar {
    width: 8px;
}
.modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}
.modal-content::-webkit-scrollbar-thumb {
    background: #d4af37;
    border-radius: 10px;
}
.modal-content::-webkit-scrollbar-thumb:hover {
    background: #b38f00;
}

body.dark-mode .modal-content {
    background: #242424;
    color: #e6e6e6;
}
body.dark-mode .modal-content::-webkit-scrollbar-track {
    background: #333;
}
body.dark-mode .modal-content::-webkit-scrollbar-thumb {
    background: #d4af37;
}

#qProgress {
    font-weight: 700; color: #d4af37; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; margin-bottom: 5px;
}
.sentence {
    font-size: 1.4rem; font-weight: 600; color: #2c3e50; line-height: 1.4; margin-bottom: 25px;
}
body.dark-mode .sentence { color: #fff; }

.options { display: grid; grid-template-columns: 1fr; gap: 12px; }
.options button {
    padding: 15px 20px; font-size: 1rem; border: 2px solid #e9ecef; border-radius: 12px;
    background: #f8f9fa; color: #333; text-align: left; font-weight: 500; transition: all 0.2s ease; cursor: pointer; font-family: 'Poppins', sans-serif;
}
.options button:hover { border-color: #d4af37; background-color: #fffdf5; }

.options button.correct { background-color: #2ecc71 !important; color: white !important; border-color: #27ae60 !important; }
.options button.wrong { background-color: #e74c3c !important; color: white !important; border-color: #c0392b !important; }

.explanation {
    margin-top: 25px; padding: 15px; background-color: #e8f4fd; color: #2980b9;
    border-radius: 12px; font-size: 0.9rem; border-left: 5px solid #3498db; display: none;
}
body.dark-mode .explanation { background-color: #1a2633; color: #5dade2; }

.score-area {
    margin-top: 30px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #f1f1f1; padding-top: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
.modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
.modal-btn { padding: 10px 25px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; }
.modal-btn.primary { background-color: #d9534f; color: white; }
.modal-btn.secondary { background-color: #e9ecef; color: #333; }

/* ===== SCORE MODAL & CONFETTI ===== */
#scoreResultModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; }
.score-card { background: white; padding: 40px; border-radius: 30px; text-align: center; max-width: 450px; width: 90%; position: relative; z-index: 5002; }
.score-number { font-size: 3.5rem; font-weight: 700; margin: 15px 0; color: maroon; }
.score-feedback { font-size: 1.1rem; color: #444; font-weight: 500; margin-bottom: 25px; line-height: 1.5; min-height: 3em; display: flex; align-items: center; justify-content: center;}
body.dark-mode .score-card { background: #242424; color: #fff; }
body.dark-mode .score-feedback { color: #ccc; }

#confetti-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5001;
    overflow: hidden;
}

.confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    top: -20px;
    border-radius: 2px;
    animation: fall 3s linear forwards;
}

@keyframes fall {
    to {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
    }
}

/* ===== BRAHMMY FEEDBACK ===== */
#brahmmyFeedback {
    width: 140px;
    height: auto;
    display: block;
    margin: 20px auto 0;
    opacity: 0;
    transition: opacity 0.5s ease;
}

#brahmmyFeedback.visible {
    opacity: 1;
}

/* Camera shake (only on wrong answer) */
.camera-shake {
    animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
}

@keyframes shake {
    10%, 90% { transform: translate3d(-3px, 0, 0); }
    20%, 80% { transform: translate3d(5px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
    40%, 60% { transform: translate3d(8px, 0, 0); }
}

/* ===== Dashboard Container ===== */
.dashboard-container {
    padding: 20px 5%;
    max-width: 1200px;
    margin: 0 auto;
}

.back-nav {
    margin-bottom: 20px;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: maroon;
    font-weight: 500;
    padding: 8px 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.back-link:hover {
    background-color: #f5f5f5;
}

body.dark-mode .back-link {
    color: #ffffff;
}

body.dark-mode .back-link:hover {
    background-color: #333;
}

.dashboard-card {
    background: #fff;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

body.dark-mode .dashboard-card {
    background: #242424;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.dashboard-card h1 {
    font-size: 2rem;
    color: maroon;
    margin-bottom: 10px;
}

body.dark-mode .dashboard-card h1 {
    color: #ffffff;
}

.subtitle {
    color: #666;
    margin-bottom: 30px;
    font-size: 1.1rem;
}

body.dark-mode .subtitle {
    color: #ccc;
}

.test-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 15px 25px;
    background: maroon;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
}

.btn:hover {
    background: #7a0c0c;
    transform: translateY(-2px);
}

body.dark-mode .btn {
    background: #7a0c0c;
}

body.dark-mode .btn:hover {
    background: #8a1c1c;
}

.footer-credit {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 0.9rem;
    margin-top: 40px;
}

body.dark-mode .footer-credit {
    color: #ccc;
}

/* ===== RESPONSIVE MEDIA QUERIES ===== */
@media screen and (max-width: 992px) {
    .dashboard-card h1 {
        font-size: 1.8rem;
    }
    
    .test-buttons {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media screen and (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }
    
    .dashboard-card {
        padding: 20px;
    }
    
    .dashboard-card h1 {
        font-size: 1.6rem;
    }
    
    .subtitle {
        font-size: 1rem;
    }
    
    .test-buttons {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 0.95rem;
    }
    
    /* Quiz modal adjustments */
    .modal-content {
        padding: 25px 20px;
        margin: 5% auto;
        width: 95%;
        max-height: 90vh;
    }
    
    .sentence {
        font-size: 1.2rem;
        line-height: 1.3;
    }
    
    .options button {
        padding: 14px 16px;
        font-size: 0.95rem;
    }
    
    .score-area {
        flex-direction: column;
        align-items: stretch;
    }
    
    .score-area .btn {
        max-width: 100%;
        width: 100%;
    }
    
    /* Score modal adjustments */
    .score-card {
        padding: 30px 20px;
        width: 95%;
    }
    
    .score-number {
        font-size: 2.8rem;
    }
    
    #brahmmyFeedback {
        width: 120px;
    }
    
    .footer-credit {
        padding: 15px;
        font-size: 0.85rem;
    }
}

@media screen and (max-width: 480px) {
    .logo {
        font-size: 1.5rem;
    }
    
    .dashboard-card h1 {
        font-size: 1.4rem;
    }
    
    .subtitle {
        font-size: 0.95rem;
    }
    
    .modal-content {
        padding: 20px 15px;
    }
    
    .sentence {
        font-size: 1.1rem;
    }
    
    .options button {
        padding: 12px 14px;
        font-size: 0.9rem;
    }
    
    .score-number {
        font-size: 2.5rem;
    }
    
    .score-feedback {
        font-size: 1rem;
    }
    
    #brahmmyFeedback {
        width: 100px;
    }
}

/* Small height devices */
@media screen and (max-height: 600px) {
    .modal-content {
        margin: 2% auto;
        max-height: 96vh;
    }
    
    .sentence {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    
    .options button {
        padding: 10px 15px;
    }
    
    #brahmmyFeedback {
        width: 100px;
        margin: 10px auto 0;
    }
}

/* Close button in modal */
.close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.close-btn:hover {
    color: #000;
    background-color: #f1f1f1;
}

body.dark-mode .close-btn {
    color: #ccc;
}

body.dark-mode .close-btn:hover {
    color: #fff;
    background-color: #333;
}
</style>
</head>

<body>

<div id="drip-container">
  <div id="dripLayer" class="drip-layer"></div>
  <svg width="0" height="0">
    <defs>
      <clipPath id="drip-path" clipPathUnits="objectBoundingBox">
        <path d="M0,0 L1,0 L1,0.8 C0.9,0.95 0.85,0.7 0.75,0.85 C0.65,1 0.55,0.75 0.5,0.9 C0.45,0.75 0.35,1 0.25,0.85 C0.15,0.7 0.1,0.95 0,0.8 Z"></path>
      </clipPath>
    </defs>
  </svg>
</div>

<div id="toast-container"></div>

<div id="scoreResultModal">
    <div id="confetti-wrapper"></div>
    <div class="score-card">
        <img id="brahmmyMedal" src="" alt="" style="display: block; margin: 0 auto 20px auto; width:220px;">
        <h2>Quiz Complete!</h2>
        <p>Iyong nakuha ay:</p>
        <div class="score-number" id="finalScoreDisplay">0/10</div>
        <p class="score-feedback" id="feedbackMessage"></p>
        <button class="modal-btn primary" onclick="closeScoreModal()" style="width: 100%;">Mahusay!</button>
    </div>
</div>

<nav>
  <button class="burger-menu" id="burgerBtn">
    <span></span><span></span><span></span>
  </button>

  <a href="index.html" class="logo">UB<span>igkas</span></a>
  
  <ul id="navLinks">
    <li><a href="student_dashboard.html">Home</a></li>
    <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
    <li><a href="About.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>

  <div class="nav-actions">
    <button id="darkModeBtn">ðŸŒ™</button>
    <button id="logoutBtn">Logout</button>
    <button id="musicToggle">Mute Music</button>
  </div>
</nav>

<div id="logoutModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Logout Confirmation</h3>
    <p>Are you sure you want to logout?</p>
    <div class="modal-actions">
      <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
      <button id="confirmLogout" class="modal-btn primary">Logout</button>
    </div>
  </div>
</div>

<audio id="bgMusic" src="assessment/music/Quiz.mp3" loop autoplay></audio>

<div class="dashboard-container">
    <div class="back-nav">
        <a href="student_dashboard.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <div class="dashboard-card">
        <h1>Filipino Grammar Quiz</h1>
        <p class="subtitle">Subukan ang iyong galing sa balarilang Filipino.</p>

        <div class="test-buttons">
            <button class="btn" data-file="vso">Sentence Structure</button>
            <button class="btn" data-file="pronouns">Pronouns (Panghalip)</button>
            <button class="btn" data-file="affixes">Verbs (Pandiwa)</button>
            <button class="btn" data-file="noun">Noun (Pangalan)</button>
            <button class="btn" data-file="adjective">Adjective (Panguri)</button>
            <button class="btn" data-file="adverb">Adverb (Pangabay)</button>
        </div>
    </div>
</div>

<div id="quizModal" class="modal">
    <div class="modal-content" id="quizContent">
        <button class="close-btn" id="closeModalBtn">Ã—</button>
        <div id="qProgress">Question 1 of 10</div>
        <p class="quiz-instruction" id="quizInstruction"></p>
        <p class="sentence" id="sentence"></p>
        <div class="options" id="options"></div>
        <div class="explanation" id="explanation"></div>

        <!-- Brahmmy feedback - below explanation -->
        <div style="text-align:center; margin-top:20px; min-height:140px;">
            <img id="brahmmyFeedback" src="" alt="Brahmmy">
        </div>

        <div class="score-area">
            <p class="score-text" id="score">Score: 0</p>
            <button class="btn" id="nextBtn" style="max-width:180px;background:#d4af37;color:maroon;border:none;border-radius:10px;padding:12px 25px;font-weight:600;">
                Next Question
            </button>
        </div>
    </div>
</div>

<div class="footer-credit">Â©2025 University of Batangas â€“ Lipa City</div>

<script type="module">
import { auth, db } from "../firebase.js";
import { signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let studentName = sessionStorage.getItem("studentName");
let studentUID  = sessionStorage.getItem("studentUID");
let classId     = sessionStorage.getItem("classId");

if (!studentName || !studentUID) { window.location.href = "../index.html"; }

function showToast(message) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
}

window.closeScoreModal = function() {
    document.getElementById("scoreResultModal").style.display = "none";
    document.getElementById("confetti-wrapper").innerHTML = "";
};

async function getRandomFeedback(score, total) {
    try {
        const res = await fetch('assessment/feedback.json');
        const feedbackData = await res.json();
        const percent = (score / total) * 100;
        
        let pool = [];
        if (percent === 100) pool = feedbackData.excellent;
        else if (percent >= 80) pool = feedbackData.great;
        else if (percent >= 50) pool = feedbackData.good;
        else pool = feedbackData.keep_trying;

        const randomIndex = Math.floor(Math.random() * pool.length);
        return pool[randomIndex];
    } catch (err) {
        console.error("Feedback fetch error:", err);
        return "Mahusay!"; 
    }
}

async function triggerScoreModal(finalScore, total) {
    const modal = document.getElementById("scoreResultModal");
    const scoreDisplay = document.getElementById("finalScoreDisplay");
    const feedbackEl = document.getElementById("feedbackMessage");
    const confettiWrapper = document.getElementById("confetti-wrapper");
    const brahmmyMedal = document.getElementById("brahmmyMedal");
    
    scoreDisplay.textContent = `${finalScore}/${total}`;
    feedbackEl.textContent = await getRandomFeedback(finalScore, total);
    
    // Show Brahmmy medal if passed (â‰¥ 50%)
    if ((finalScore / total) >= 0.5) {
        brahmmyMedal.src = "../brahmmy-img/brahmmy-medal.png";
        brahmmyMedal.style.display = "block";
    } else {
        brahmmyMedal.style.display = "none";
    }
    
    modal.style.display = "flex";
    confettiWrapper.innerHTML = "";
    
    if ((finalScore / total) >= 0.5) {
        const colors = ['#d4af37', 'maroon', '#ffffff', '#ff0000', '#ffd700'];
        for(let i=0; i<100; i++) {
            const confetti = document.createElement("div");
            confetti.className = "confetti";
            confetti.style.left = Math.random() * 100 + "vw";
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + "s";
            confetti.style.width = Math.random() * 8 + 5 + "px";
            confetti.style.height = confetti.style.width;
            confettiWrapper.appendChild(confetti);
        }
    }
}

let questions = [];
let score = 0;
let currentQuiz = "";
let currentQuestionIndex = 0;
let answered = false;

const modal = document.getElementById("quizModal");
const sentenceEl = document.getElementById("sentence");
const optionsEl = document.getElementById("options");
const explanationEl = document.getElementById("explanation");
const nextBtn = document.getElementById("nextBtn");
const scoreEl = document.getElementById("score");
const instructionEl = document.getElementById("quizInstruction");
const progressEl = document.getElementById("qProgress");
const quizContent = document.getElementById("quizContent");
const brahmmyFeedback = document.getElementById("brahmmyFeedback");

const quizPaths = {
    vso: "assessment/sentence_structure.json",
    pronouns: "assessment/pronoun_questions.json",
    affixes: "assessment/affix_questions.json",
    noun: "assessment/noun_questions.json",
    adjective: "assessment/adjective_questions.json",
    adverb: "assessment/Adverb_questions.json"
};

const quizInstructions = {
    vso: "Panuto: Piliin ang tamang ayos ng pangungusap (Verbâ€“Subjectâ€“Object).",
    pronouns: "Panuto: Piliin ang tamang panghalip na angkop sa pangungusap.",
    affixes: "Panuto: Piliin ang tamang pandiwa ayon sa aspekto o panlapi."
};

document.querySelectorAll(".test-buttons button").forEach(btn => {
    btn.addEventListener("click", () => startQuiz(btn.dataset.file));
});

function startQuiz(quizName) {
    score = 0;
    currentQuestionIndex = 0;
    currentQuiz = quizName;
    instructionEl.textContent = quizInstructions[quizName] || "Panuto: Sagutin ang sumusunod.";
    scoreEl.textContent = "Score: 0";
    fetch(quizPaths[quizName])
        .then(res => res.json())
        .then(data => {
            questions = data.sort(() => 0.5 - Math.random()).slice(0, 10);
            modal.style.display = "block";
            loadQuestion();
        })
        .catch(err => {
            console.error("Error loading quiz:", err);
            showToast("Error loading quiz questions.");
        });
}

function loadQuestion() {
    if (currentQuestionIndex >= questions.length) {
        saveScore();
        modal.style.display = "none";
        triggerScoreModal(score, questions.length);
        return;
    }

    answered = false;
    nextBtn.disabled = true;
    nextBtn.style.opacity = "0.5";
    progressEl.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;

    const q = questions[currentQuestionIndex];
    sentenceEl.textContent = q.wrongSentence;
    optionsEl.innerHTML = "";
    explanationEl.style.display = "none";

    // Show Brahmmy thinking while user is answering
    brahmmyFeedback.src = "../brahmmy-img/brahmmy-thinking.png";
    brahmmyFeedback.style.opacity = "1";

    q.options.sort(() => 0.5 - Math.random()).forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.onclick = () => {
            if (answered) return;
            answered = true;
            nextBtn.disabled = false;
            nextBtn.style.opacity = "1";

            // Hide thinking Brahmmy when answered
            brahmmyFeedback.style.opacity = "0";

            if (option === q.correctOption) {
                btn.classList.add("correct");
                score++;

                // Right answer: happy Brahmmy + confetti
                brahmmyFeedback.src = "../brahmmy-img/brahmmy-clapping.png";
                brahmmyFeedback.style.opacity = "1";
                triggerConfetti();
            } else {
                btn.classList.add("wrong");
                Array.from(optionsEl.children).forEach(child => {
                    if (child.textContent === q.correctOption) {
                        child.classList.add("correct");
                    }
                });

                // Wrong answer: angry Brahmmy + camera shake
                brahmmyFeedback.src = "../brahmmy-img/brahmmy-sad.png";
                brahmmyFeedback.style.opacity = "1";
                quizContent.classList.add("camera-shake");
                setTimeout(() => quizContent.classList.remove("camera-shake"), 600);
            }

            explanationEl.textContent = q.explanation;
            explanationEl.style.display = "block";
            scoreEl.textContent = `Score: ${score}`;
        };
        optionsEl.appendChild(btn);
    });
}

function triggerConfetti() {
    const wrapper = document.getElementById("confetti-wrapper") || document.createElement("div");
    if (!document.getElementById("confetti-wrapper")) {
        wrapper.id = "confetti-wrapper";
        wrapper.style.cssText = "position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden;";
        document.body.appendChild(wrapper);
    }

    const colors = ['#d4af37', 'maroon', '#ffffff', '#ff0000', '#ffd700'];
    for(let i = 0; i < 60; i++) {
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random() * 100 + "vw";
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = Math.random() * 1.2 + "s";
        c.style.width = Math.random() * 6 + 6 + "px";
        c.style.height = c.style.width;
        wrapper.appendChild(c);
        setTimeout(() => c.remove(), 4000);
    }
}

async function saveScore() {
    try {
        const docRef = doc(db, "students", studentUID, "assessments", currentQuiz);
        await setDoc(docRef, {
            studentUID, studentName, classId,
            quizType: currentQuiz, score, total: questions.length,
            takenAt: serverTimestamp()
        }, { merge: true });
    } catch (err) { console.error("Error saving score:", err); }
}

/* ===================== MOBILE NAVIGATION ===================== */
const burgerBtn = document.getElementById("burgerBtn");
const navLinks = document.getElementById("navLinks");

burgerBtn.onclick = (e) => {
    e.stopPropagation();
    navLinks.classList.toggle("show");
};

// Close sidebar when clicking outside
document.addEventListener('click', (event) => {
    if (!burgerBtn.contains(event.target) && !navLinks.contains(event.target)) {
        navLinks.classList.remove("show");
    }
});

/* ===================== LOGOUT FUNCTIONALITY ===================== */
const logoutBtn = document.getElementById("logoutBtn");
const logoutModal = document.getElementById("logoutModal");
const cancelLogout = document.getElementById("cancelLogout");
const confirmLogout = document.getElementById("confirmLogout");

logoutBtn.onclick = () => { logoutModal.style.display = "flex"; };
cancelLogout.onclick = () => { logoutModal.style.display = "none"; };

confirmLogout.onclick = async () => {
    showToast("Logging out...");
    try {
        if (studentUID) {
            const studentRef = doc(db, "students", studentUID);
            await updateDoc(studentRef, { status: "offline", lastSeen: serverTimestamp() });
        }
        await signOut(auth);
        sessionStorage.clear();
        window.location.href = "../index.html";
    } catch (err) { window.location.href = "../index.html"; }
};

nextBtn.onclick = () => { currentQuestionIndex++; loadQuestion(); };
document.getElementById("closeModalBtn").onclick = () => { modal.style.display = "none"; };

const bgMusic = document.getElementById("bgMusic");
const musicToggle = document.getElementById("musicToggle");
let isMuted = false;
musicToggle.onclick = () => {
    isMuted = !isMuted;
    bgMusic.muted = isMuted;
    musicToggle.textContent = isMuted ? "Unmute Music" : "Mute Music";
};

/* ===================== DARK MODE SWITCHER ===================== */
const darkModeBtn = document.getElementById("darkModeBtn");
const dripContainer = document.getElementById("drip-container");
const dripLayer = document.getElementById("dripLayer");

function updateThemeText(isDark) {
    darkModeBtn.textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
}

darkModeBtn.onclick = () => {
    const isDark = document.body.classList.contains("dark-mode");
    
    // Set drip color BEFORE showing it
    if (!isDark) {
        // Going to dark mode - set dark background
        dripLayer.classList.remove("drip-light");
    } else {
        // Going to light mode - set light background
        dripLayer.classList.add("drip-light");
    }
    
    dripContainer.classList.add("active");

    setTimeout(() => {
        document.body.classList.toggle("dark-mode");
        const nowDark = document.body.classList.contains("dark-mode");
        updateThemeText(nowDark);
        localStorage.setItem("theme", nowDark ? "dark" : "light");
    }, 350);

    setTimeout(() => {
        dripContainer.classList.remove("active");
    }, 700);
};

// Initialize theme on page load
if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    updateThemeText(true);
}

// Close modals when clicking outside
window.onclick = (event) => {
    if (event.target == logoutModal) {
        logoutModal.style.display = "none";
    }
    if (event.target == modal) {
        modal.style.display = "none";
    }
};
</script>

</body>
</html>
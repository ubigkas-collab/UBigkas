<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Filipino Grammar Quiz | UBigkas</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="grammar_quiz.css">

<style>
/* ===== TEXT SCALING VARIABLE ===== */
:root {
    --text-scale: 100%;
    --maroon: #7a0c0c;
    --gold: #d4af37;
    --bg: #f8f9fa;
    --card-bg: #fff;
    --nav-text: #333;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --danger: #d9534f;
    --success: #28a745;
    --warning: #ffc107;
}

body {
    font-size: var(--text-scale);
    transition: background-color 0.3s ease;
    margin: 0;
    overflow-x: hidden;
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg);
    color: var(--nav-text);
}

/* ===== DRIP EFFECT INTEGRATION ===== */
#drip-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10000;
}
.drip-layer {
    position: absolute;
    top: -110%;
    left: 0;
    width: 100%;
    height: 120%;
    background-color: #181818;
    transition: top 0.7s cubic-bezier(0.645, 0.045, 0.355, 1);
    clip-path: url(#drip-path);
}
#drip-container.active .drip-layer {
    top: 0;
}
.drip-light { background-color: #fdfdfd !important; }

.quiz-instruction {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 12px;
    font-weight: 500;
}

/* ===== EXACT COPY OF STUDENT DASHBOARD NAVIGATION ===== */
nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 5%;
    height: 80px;
    background-color: var(--card-bg);
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
    border-bottom: 3px solid var(--maroon);
}

nav .logo {
    font-size: 1.8rem;
    font-weight: 800;
    text-decoration: none;
    color: var(--maroon);
}
nav .logo span { color: var(--gold); }

.nav-links {
    display: flex;
    list-style: none;
    gap: 30px;
    margin: 0;
    padding: 0;
}

.nav-links li a {
    text-decoration: none;
    color: var(--nav-text);
    font-weight: 500;
    transition: color 0.3s;
}

.nav-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ===== BURGER MENU BUTTON ===== */
.burger-menu {
    display: none;
    flex-direction: column;
    gap: 5px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 10px;
    z-index: 1002;
}
.burger-menu span {
    width: 25px;
    height: 3px;
    background-color: var(--maroon);
    border-radius: 2px;
    transition: 0.3s;
}

/* ===== SETTINGS DROPDOWN (EXACT SAME AS STUDENT DASHBOARD) ===== */
.dropdown {
    position: relative;
    display: inline-block;
}

#settingsBtn {
    padding: 10px 20px;
    border-radius: 25px;
    background-color: var(--maroon);
    color: white;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
}

.dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background-color: white;
    min-width: 220px;
    margin-top: 10px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    border-radius: 12px;
    z-index: 1000;
    overflow: hidden;
}
.dropdown:hover .dropdown-content { display: block; }
.dropdown-content.is-active { display: block; }
.dropdown-content button {
    width: 100%;
    padding: 12px 16px;
    text-align: left;
    border: none;
    background: none;
    font-family: 'Poppins', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s;
    color: #333;
}
.dropdown-content button:hover { background-color: #f1f1f1; }
#logoutBtn { color: var(--danger) !important; font-weight: 700; }
#changePasswordBtn { color: var(--maroon) !important; }

/* Mobile Side Drawer (EXACT SAME AS STUDENT DASHBOARD) */
.mobile-menu {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    height: 100vh;
    background-color: var(--card-bg);
    display: flex;
    flex-direction: column;
    padding: 100px 30px 30px;
    box-shadow: 10px 0 20px rgba(0,0,0,0.1);
    transition: left 0.4s cubic-bezier(0.77, 0, 0.175, 1);
    z-index: 1001;
    margin: 0;
    list-style: none;
}
.mobile-menu.show { left: 0; }
.mobile-menu li a { 
    display: block; 
    padding: 15px 0; 
    text-decoration: none; 
    color: var(--nav-text); 
    font-weight: 500; 
}
.mobile-menu button { 
    width: 100%; 
    padding: 12px; 
    margin-top: 10px; 
    text-align: left;
    background: #f1f1f1; 
    border: none; 
    border-radius: 8px; 
    font-family: inherit; 
    cursor: pointer;
}

/* ===== DARK MODE STYLES (EXACT SAME AS STUDENT DASHBOARD) ===== */
body.dark-mode { 
    background-color: #181818; 
    color: #ffffff; 
    --bg: #181818;
    --card-bg: #1e1e1e;
    --nav-text: #ffffff;
}
body.dark-mode nav { background-color: #202020; }
body.dark-mode nav .logo { color: #ffffff; }
body.dark-mode .nav-links li a { color: #ffffff; }
body.dark-mode .dropdown-content { 
    background-color: #242424; 
    border: 1px solid #333; 
}
body.dark-mode .dropdown-content button { color: #e6e6e6; }
body.dark-mode .dropdown-content button:hover { background-color: #333; }
body.dark-mode .burger-menu span { background-color: #ffffff; }
body.dark-mode .mobile-menu { background-color: #1e1e1e; }
body.dark-mode .mobile-menu button { background: #2a2a2a; color: white; }
body.dark-mode .dashboard-card, 
body.dark-mode .modal-content,
body.dark-mode .score-card {
    background-color: #242424; 
    color: #e6e6e6; 
    border: 1px solid #333;
}

/* ===== MOBILE RESPONSIVE (EXACT SAME AS STUDENT DASHBOARD) ===== */
@media (max-width: 850px) {
    nav {
        height: 70px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0 20px;
    }

    .burger-menu {
        display: flex;
        grid-column: 1;
        justify-self: start;
    }

    nav .logo {
        grid-column: 2;
        justify-self: center;
        font-size: 1.5rem;
    }

    .nav-actions {
        grid-column: 3;
        justify-self: end;
    }

    .nav-links {
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        background-color: var(--card-bg);
        flex-direction: column;
        padding: 100px 30px 30px 30px;
        gap: 25px;
        box-shadow: 10px 0 20px rgba(0,0,0,0.1);
        transition: left 0.4s cubic-bezier(0.77, 0, 0.175, 1);
        z-index: 1001;
    }

    .nav-links.show {
        left: 0;
    }

    .nav-links li a {
        font-size: 1.2rem;
        display: block;
        width: 100%;
    }

    body.dark-mode .nav-links {
        background-color: #202020;
        box-shadow: 10px 0 20px rgba(0,0,0,0.4);
    }

    .dashboard-container { padding: 20px 5%; }
}

/* ===== DASHBOARD & CARDS ===== */
.dashboard-container { padding: 40px 5%; max-width: 1200px; margin: 0 auto; }
.dashboard-card { 
    background: var(--card-bg); 
    padding: 30px; 
    border-radius: 20px; 
    margin-bottom: 20px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
}

.subtitle {
    color: #666;
    margin-bottom: 30px;
    font-size: 1.1rem;
}

.test-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 15px 25px;
    background: var(--maroon);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
    text-align: center;
}

.btn:hover {
    background: #5a0909;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(122, 12, 12, 0.2);
}

.back-nav {
    margin-bottom: 30px;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--maroon);
    text-decoration: none;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 25px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.back-link:hover {
    background: #e9ecef;
}

/* ===== QUIZ MODAL REFINEMENTS ===== */
.modal {
    display: none; 
    position: fixed; 
    z-index: 2500; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8); 
    backdrop-filter: blur(8px);
}
.modal-content {
    background: var(--card-bg); 
    margin: 5% auto; 
    padding: 40px; 
    border-radius: 25px;
    max-width: 650px; 
    width: 90%; 
    position: relative; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}
#qProgress {
    font-weight: 700; 
    color: #d4af37; 
    text-transform: uppercase; 
    letter-spacing: 1px; 
    font-size: 0.85rem; 
    margin-bottom: 5px;
}
.sentence {
    font-size: 1.4rem; 
    font-weight: 600; 
    color: #2c3e50; 
    line-height: 1.4; 
    margin-bottom: 25px;
}
body.dark-mode .sentence { color: #fff; }

.options { display: grid; grid-template-columns: 1fr; gap: 12px; }
.options button {
    padding: 15px 20px; 
    font-size: 1rem; 
    border: 2px solid #e9ecef; 
    border-radius: 12px;
    background: #f8f9fa; 
    color: #333; 
    text-align: left; 
    font-weight: 500; 
    transition: all 0.2s ease; 
    cursor: pointer; 
    font-family: 'Poppins', sans-serif;
}
.options button:hover { border-color: #d4af37; background-color: #fffdf5; }

.options button.correct { background-color: #2ecc71 !important; color: white !important; border-color: #27ae60 !important; }
.options button.wrong { background-color: #e74c3c !important; color: white !important; border-color: #c0392b !important; }

.explanation {
    margin-top: 25px; 
    padding: 15px; 
    background-color: #e8f4fd; 
    color: #2980b9;
    border-radius: 12px; 
    font-size: 0.9rem; 
    border-left: 5px solid #3498db; 
    display: none;
}
body.dark-mode .explanation { background-color: #1a2633; color: #5dade2; }

.score-area {
    margin-top: 30px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-top: 2px solid #f1f1f1; 
    padding-top: 20px;
}

/* Modal overlays */
.modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0, 0, 0, 0.7); 
    z-index: 4000; 
    justify-content: center; 
    align-items: center; 
    backdrop-filter: blur(4px); 
}
.modal-card { 
    background: var(--card-bg); 
    padding: 30px; 
    border-radius: 20px; 
    width: 90%; 
    max-width: 400px; 
    text-align: center; 
}
.modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
.modal-btn { 
    padding: 10px 25px; 
    border-radius: 25px; 
    border: none; 
    font-weight: 600; 
    cursor: pointer; 
    font-family: 'Poppins', sans-serif; 
}
.modal-btn.primary { background-color: var(--danger); color: white; }
.modal-btn.secondary { background-color: #e9ecef; color: #333; }
body.dark-mode .modal-btn.secondary { background-color: #333; color: #fff; }

/* ===== SCORE MODAL & CONFETTI ===== */
#scoreResultModal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.85); 
    z-index: 5000; 
    justify-content: center; 
    align-items: center; 
}
.score-card { 
    background: var(--card-bg); 
    padding: 40px; 
    border-radius: 30px; 
    text-align: center; 
    max-width: 450px; 
    width: 90%; 
    position: relative; 
    z-index: 5002; 
}
.score-number { 
    font-size: 3.5rem; 
    font-weight: 700; 
    margin: 15px 0; 
    color: var(--maroon); 
}
.score-feedback { 
    font-size: 1.1rem; 
    color: #444; 
    font-weight: 500; 
    margin-bottom: 25px; 
    line-height: 1.5; 
    min-height: 3em; 
    display: flex; 
    align-items: center; 
    justify-content: center;
}
body.dark-mode .score-card { background: #242424; color: #fff; }
body.dark-mode .score-feedback { color: #ccc; }

#confetti-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5001; 
    overflow: hidden;
}

.confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    top: -20px;
    border-radius: 2px;
    animation: fall 3s linear forwards;
}

@keyframes fall {
    to {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
    }
}

.footer-credit { 
    text-align: center; 
    padding: 20px; 
    color: #888; 
    font-size: 0.8rem; 
}
body.dark-mode .footer-credit { color: #777; }
</style>
</head>

<body>

<div id="drip-container">
  <div id="dripLayer" class="drip-layer"></div>
  <svg width="0" height="0">
    <defs>
      <clipPath id="drip-path" clipPathUnits="objectBoundingBox">
        <path d="M0,0 L1,0 L1,0.8 C0.9,0.95 0.85,0.7 0.75,0.85 C0.65,1 0.55,0.75 0.5,0.9 C0.45,0.75 0.35,1 0.25,0.85 C0.15,0.7 0.1,0.95 0,0.8 Z"></path>
      </clipPath>
    </defs>
  </svg>
</div>

<div id="toast-container"></div>

<div id="scoreResultModal">
    <div id="confetti-wrapper"></div>
    <div class="score-card">
        <h2>Quiz Complete!</h2>
        <p>Iyong nakuha ay:</p>
        <div class="score-number" id="finalScoreDisplay">0/10</div>
        <p class="score-feedback" id="feedbackMessage"></p>
        <button class="modal-btn primary" onclick="closeScoreModal()" style="width: 100%;">Mahusay!</button>
    </div>
</div>

<!-- EXACT COPY OF STUDENT DASHBOARD NAVIGATION -->
<nav>
  <button class="burger-menu" id="burgerBtn">
    <span></span><span></span><span></span>
  </button>

  <a href="student_dashboard.html" class="logo">UB<span>igkas</span></a>
  
  <!-- Desktop Navigation Links -->
  <ul class="nav-links" id="navLinks">
    <li><a href="student_dashboard.html">Home</a></li>
    <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>

  <div class="nav-actions">
    <div class="dropdown">
      <button id="settingsBtn">Settings ‚öôÔ∏è</button>
      <div class="dropdown-content" id="settingsDropdown">
        <button id="darkModeBtn">üåô Dark Mode</button>
        <button id="textSizeBtn">üîç Text Size: 100%</button>
        <button id="musicToggle">üîä Mute Music</button>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;">
        <button id="logoutBtn">üö™ Logout</button>
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Menu (EXACT SAME AS STUDENT DASHBOARD) -->
<ul class="mobile-menu" id="mobileMenu">
  <li><a href="student_dashboard.html">Home</a></li>
  <li><a href="grammar_corrector.html">Grammar Corrector</a></li>
  <li><a href="about.html">About</a></li>
  <li><a href="contact.html">Contact</a></li>
  <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
    <button id="mobileDarkModeBtn">üåô Dark Mode</button>
    <button id="mobileTextSizeBtn">üîç Text Size: 100%</button>
    <button id="mobileMusicToggle">üîä Mute Music</button>
    <button id="mobileLogoutBtn" style="color:var(--danger);">üö™ Logout</button>
  </div>
</ul>

<!-- LOGOUT MODAL -->
<div id="logoutModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Logout Confirmation</h3>
    <p>Are you sure you want to logout?</p>
    <div class="modal-actions">
      <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
      <button id="confirmLogout" class="modal-btn primary">Logout</button>
    </div>
  </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div id="changePasswordModal" class="modal-overlay">
  <div class="modal-card">
    <h3>Change Password</h3>
    <form id="changePasswordForm">
      <div class="form-group">
        <label>Current Password</label>
        <input type="password" id="currentPassword" required>
      </div>
      <div class="form-group">
        <label>New Password</label>
        <input type="password" id="newPassword" required minlength="6">
      </div>
      <div class="form-group">
        <label>Confirm New Password</label>
        <input type="password" id="confirmPassword" required>
      </div>
      <div class="modal-actions">
        <button type="button" id="cancelPasswordChange" class="modal-btn secondary">Cancel</button>
        <button type="submit" class="modal-btn primary">Change Password</button>
      </div>
    </form>
  </div>
</div>

<audio id="bgMusic" src="assessment/music/Quiz.mp3" loop autoplay></audio>

<div class="dashboard-container">
    <div class="back-nav">
        <a href="student_dashboard.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <div class="dashboard-card">
        <h1>Filipino Grammar Quiz</h1>
        <p class="subtitle">Subukan ang iyong galing sa balarilang Filipino.</p>

        <div class="test-buttons">
            <button class="btn" data-file="vso">Sentence Structure</button>
            <button class="btn" data-file="pronouns">Pronouns (Panghalip)</button>
            <button class="btn" data-file="affixes">Verbs (Pandiwa)</button>
            <button class="btn" data-file="noun">Noun (Pangalan)</button>
            <button class="btn" data-file="adjective">Adjective (Panguri)</button>
            <button class="btn" data-file="adverb">Adverb (Pangabay)</button>
        </div>
    </div>
</div>

<div id="quizModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" id="closeModalBtn">√ó</button>
        <div id="qProgress">Question 1 of 10</div>
        <p class="quiz-instruction" id="quizInstruction"></p>
        <p class="sentence" id="sentence"></p>
        <div class="options" id="options"></div>
        <div class="explanation" id="explanation"></div>
        <div class="score-area">
            <p class="score-text" id="score">Score: 0</p>
            <button class="btn" id="nextBtn" style="max-width:180px;background:#d4af37;color:white;border:none;border-radius:10px;padding:12px 25px;">
                Next Question
            </button>
        </div>
    </div>
</div>

<div class="footer-credit">¬©2025 University of Batangas ‚Äì Lipa City</div>

<script type="module">
import { auth, db } from "../firebase.js";
import { signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------------- NAVIGATION LOGIC (EXACT SAME AS STUDENT DASHBOARD) ----------------
const burgerBtn = document.getElementById("burgerBtn");
const navLinks = document.getElementById("navLinks");
const settingsBtn = document.getElementById("settingsBtn");
const dropdownMenu = document.getElementById("settingsDropdown");
const mobileMenu = document.getElementById("mobileMenu");

burgerBtn.onclick = (e) => {
    e.stopPropagation();
    navLinks.classList.toggle("show");
    mobileMenu.classList.toggle("show");
};

settingsBtn.onclick = (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("is-active");
};

document.addEventListener('click', (event) => {
    if (!settingsBtn.contains(event.target)) {
        dropdownMenu.classList.remove("is-active");
    }
    if (!burgerBtn.contains(event.target) && !navLinks.contains(event.target) && !mobileMenu.contains(event.target)) {
        navLinks.classList.remove("show");
        mobileMenu.classList.remove("show");
    }
});

let studentName = sessionStorage.getItem("studentName");
let studentUID  = sessionStorage.getItem("studentUID");
let classId     = sessionStorage.getItem("classId");

if (!studentName || !studentUID) { window.location.href = "../index.html"; }

function showToast(message) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
}

window.closeScoreModal = function() {
    document.getElementById("scoreResultModal").style.display = "none";
    document.getElementById("confetti-wrapper").innerHTML = "";
};

async function getRandomFeedback(score, total) {
    try {
        const res = await fetch('assessment/feedback.json');
        const feedbackData = await res.json();
        const percent = (score / total) * 100;
        
        let pool = [];
        if (percent === 100) pool = feedbackData.excellent;
        else if (percent >= 80) pool = feedbackData.great;
        else if (percent >= 50) pool = feedbackData.good;
        else pool = feedbackData.keep_trying;

        const randomIndex = Math.floor(Math.random() * pool.length);
        return pool[randomIndex];
    } catch (err) {
        console.error("Feedback fetch error:", err);
        return "Mahusay!"; 
    }
}

async function triggerScoreModal(finalScore, total) {
    const modal = document.getElementById("scoreResultModal");
    const scoreDisplay = document.getElementById("finalScoreDisplay");
    const feedbackEl = document.getElementById("feedbackMessage");
    const confettiWrapper = document.getElementById("confetti-wrapper");
    
    scoreDisplay.textContent = `${finalScore}/${total}`;
    feedbackEl.textContent = await getRandomFeedback(finalScore, total);
    
    modal.style.display = "flex";
    confettiWrapper.innerHTML = "";
    
    // CONFETTI LOGIC
    if ((finalScore / total) >= 0.5) {
        const colors = ['#d4af37', '#7a0c0c', '#ffffff', '#ff0000', '#ffd700'];
        for(let i=0; i<100; i++) {
            const confetti = document.createElement("div");
            confetti.className = "confetti";
            confetti.style.left = Math.random() * 100 + "vw";
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + "s";
            confetti.style.width = Math.random() * 8 + 5 + "px";
            confetti.style.height = confetti.style.width;
            confettiWrapper.appendChild(confetti);
        }
    }
}

let questions = [];
let score = 0;
let currentQuiz = "";
let currentQuestionIndex = 0;
let answered = false;

const modal = document.getElementById("quizModal");
const sentenceEl = document.getElementById("sentence");
const optionsEl = document.getElementById("options");
const explanationEl = document.getElementById("explanation");
const nextBtn = document.getElementById("nextBtn");
const scoreEl = document.getElementById("score");
const instructionEl = document.getElementById("quizInstruction");
const progressEl = document.getElementById("qProgress");

const quizPaths = {
    vso: "assessment/sentence_structure.json",
    pronouns: "assessment/pronoun_questions.json",
    affixes: "assessment/affix_questions.json",
    noun: "assessment/noun_questions.json",
    adjective: "assessment/panguri_questions.json",
    adverb: "assessment/adverb_questions.json"
};

const quizInstructions = {
    vso: "Panuto: Piliin ang tamang ayos ng pangungusap (Verb‚ÄìSubject‚ÄìObject).",
    pronouns: "Panuto: Piliin ang tamang panghalip na angkop sa pangungusap.",
    affixes: "Panuto: Piliin ang tamang pandiwa ayon sa aspekto o panlapi.",
    noun: "Panuto: Tukuyin ang tamang pangngalan o pananda (si/ang/ng/ni) para sa pangungusap.",
    adjective: "Panuto: Piliin ang tamang pang-uri o antas ng hambingang angkop sa konteksto.",
    adverb: "Panuto: Piliin ang tamang pang-abay at wastong gamit ng 'ng' at 'nang'."
};

document.querySelectorAll(".test-buttons button").forEach(btn => {
    btn.addEventListener("click", () => startQuiz(btn.dataset.file));
});

function startQuiz(quizName) {
    score = 0;
    currentQuestionIndex = 0;
    currentQuiz = quizName;
    instructionEl.textContent = quizInstructions[quizName] || "Panuto: Sagutin ang sumusunod.";
    scoreEl.textContent = "Score: 0";
    fetch(quizPaths[quizName])
        .then(res => res.json())
        .then(data => {
            questions = data.sort(() => 0.5 - Math.random()).slice(0, 10);
            modal.style.display = "block";
            loadQuestion();
        })
        .catch(err => showToast("Error loading quiz questions."));
}

function loadQuestion() {
    if (currentQuestionIndex >= questions.length) {
        saveScore();
        modal.style.display = "none";
        triggerScoreModal(score, questions.length);
        return;
    }

    answered = false;
    nextBtn.disabled = true;
    nextBtn.style.opacity = "0.5";
    progressEl.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;

    const q = questions[currentQuestionIndex];
    sentenceEl.textContent = q.wrongSentence;
    optionsEl.innerHTML = "";
    explanationEl.style.display = "none";

    q.options.sort(() => 0.5 - Math.random()).forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.onclick = () => {
            if (answered) return;
            answered = true;
            nextBtn.disabled = false;
            nextBtn.style.opacity = "1";

            if (option === q.correctOption) {
                btn.classList.add("correct");
                score++;
            } else {
                btn.classList.add("wrong");
                Array.from(optionsEl.children).forEach(child => {
                    if (child.textContent === q.correctOption) {
                        child.classList.add("correct");
                    }
                });
            }
            explanationEl.textContent = q.explanation;
            explanationEl.style.display = "block";
            scoreEl.textContent = `Score: ${score}`;
        };
        optionsEl.appendChild(btn);
    });
}

async function saveScore() {
    try {
        const docRef = doc(db, "students", studentUID, "assessments", currentQuiz);
        await setDoc(docRef, {
            studentUID, studentName, classId,
            quizType: currentQuiz, score, total: questions.length,
            takenAt: serverTimestamp()
        }, { merge: true });
    } catch (err) { console.error("Error saving score:", err); }
}

/* ===================== TEXT SIZE LOGIC (EXACT SAME AS STUDENT DASHBOARD) ===================== */
const textSizeBtn = document.getElementById("textSizeBtn");
const mobileTextSizeBtn = document.getElementById("mobileTextSizeBtn");
const sizes = ["100%", "115%", "130%"];
let currentSizeIndex = sizes.indexOf(localStorage.getItem("textSize") || "100%");
if(currentSizeIndex === -1) currentSizeIndex = 0;

function updateTextSize() {
  const newSize = sizes[currentSizeIndex];
  document.documentElement.style.setProperty('--text-scale', newSize);
  textSizeBtn.textContent = `üîç Text Size: ${newSize}`;
  mobileTextSizeBtn.textContent = `üîç Text Size: ${newSize}`;
  localStorage.setItem("textSize", newSize);
}

textSizeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  currentSizeIndex = (currentSizeIndex + 1) % sizes.length;
  updateTextSize();
});

mobileTextSizeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  currentSizeIndex = (currentSizeIndex + 1) % sizes.length;
  updateTextSize();
  mobileMenu.classList.remove("show");
});

updateTextSize();

/* ===================== THEME SWITCHER (EXACT SAME AS STUDENT DASHBOARD) ===================== */
const darkModeBtn = document.getElementById("darkModeBtn");
const mobileDarkModeBtn = document.getElementById("mobileDarkModeBtn");
const dripContainer = document.getElementById("drip-container");
const dripLayer = document.getElementById("dripLayer");

function updateThemeText(isDark) {
    const text = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
    darkModeBtn.textContent = text;
    mobileDarkModeBtn.textContent = text;
}

function toggleTheme() {
  const isDark = document.body.classList.contains("dark-mode");
  if (isDark) dripLayer.classList.add("drip-light");
  else dripLayer.classList.remove("drip-light");

  dripContainer.classList.add("active");

  setTimeout(() => {
    document.body.classList.toggle("dark-mode");
    const nowDark = document.body.classList.contains("dark-mode");
    updateThemeText(nowDark);
    localStorage.setItem("theme", nowDark ? "dark" : "light");
  }, 350);

  setTimeout(() => { dripContainer.classList.remove("active"); }, 700);
}

darkModeBtn.onclick = (e) => {
  e.stopPropagation();
  toggleTheme();
  dropdownMenu.classList.remove("is-active");
};

mobileDarkModeBtn.onclick = (e) => {
  e.stopPropagation();
  toggleTheme();
  mobileMenu.classList.remove("show");
};

if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  updateThemeText(true);
} else {
  updateThemeText(false);
}

/* ===================== MUSIC TOGGLE LOGIC ===================== */
const bgMusic = document.getElementById("bgMusic");
const musicToggle = document.getElementById("musicToggle");
const mobileMusicToggle = document.getElementById("mobileMusicToggle");
let isMuted = false;

function toggleMusic() {
    isMuted = !isMuted;
    bgMusic.muted = isMuted;
    musicToggle.textContent = isMuted ? "üîä Unmute Music" : "üîá Mute Music";
    mobileMusicToggle.textContent = isMuted ? "üîä Unmute Music" : "üîá Mute Music";
}

musicToggle.onclick = (e) => {
    e.stopPropagation();
    toggleMusic();
    dropdownMenu.classList.remove("is-active");
};

mobileMusicToggle.onclick = (e) => {
    e.stopPropagation();
    toggleMusic();
    mobileMenu.classList.remove("show");
};

/* ===================== LOGOUT LOGIC (EXACT SAME AS STUDENT DASHBOARD) ===================== */
const logoutBtn = document.getElementById("logoutBtn");
const mobileLogoutBtn = document.getElementById("mobileLogoutBtn");
const logoutModal = document.getElementById("logoutModal");
const cancelLogout = document.getElementById("cancelLogout");
const confirmLogout = document.getElementById("confirmLogout");

function openLogoutModal() {
    logoutModal.style.display = "flex";
    dropdownMenu.classList.remove("is-active");
    mobileMenu.classList.remove("show");
}

logoutBtn.addEventListener('click', (e) => { 
    e.stopPropagation(); 
    openLogoutModal();
});

mobileLogoutBtn.addEventListener('click', (e) => { 
    e.stopPropagation(); 
    openLogoutModal();
});

cancelLogout.onclick = () => { logoutModal.style.display = "none"; };

confirmLogout.onclick = async () => {
  if (studentUID) await setStudentStatus(studentUID, "offline");
  await signOut(auth);
  sessionStorage.clear();
  window.location.href = "../index.html";
};

async function setStudentStatus(uid, status) {
  try {
    const studentRef = doc(db, "students", uid);
    await updateDoc(studentRef, { status: status, lastSeen: serverTimestamp() });
  } catch (err) { console.error("Status update failed:", err); }
}

nextBtn.onclick = () => { currentQuestionIndex++; loadQuestion(); };
document.getElementById("closeModalBtn").onclick = () => { modal.style.display = "none"; };

/* ===================== CHANGE PASSWORD LOGIC (EXACT SAME AS STUDENT DASHBOARD) ===================== */
const changePasswordBtn = document.getElementById("changePasswordBtn");
const mobileChangePasswordBtn = document.getElementById("mobileChangePasswordBtn");
const changePasswordModal = document.getElementById("changePasswordModal");
const cancelPasswordChange = document.getElementById("cancelPasswordChange");
const changePasswordForm = document.getElementById("changePasswordForm");

function openChangePasswordModal() {
    changePasswordModal.style.display = "flex";
    dropdownMenu.classList.remove("is-active");
    mobileMenu.classList.remove("show");
}

changePasswordBtn.onclick = (e) => {
    e.stopPropagation();
    openChangePasswordModal();
};

mobileChangePasswordBtn.onclick = (e) => {
    e.stopPropagation();
    openChangePasswordModal();
};

cancelPasswordChange.onclick = () => {
    changePasswordModal.style.display = "none";
    changePasswordForm.reset();
};

changePasswordForm.onsubmit = async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById("currentPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    
    // Validation
    if (newPassword !== confirmPassword) {
        alert("New passwords do not match!");
        return;
    }
    
    if (newPassword.length < 6) {
        alert("Password must be at least 6 characters long!");
        return;
    }
    
    try {
        const user = auth.currentUser;
        
        if (!user.email) {
            alert("User email not found. Please contact support.");
            return;
        }
        
        // Re-authenticate user
        const credential = EmailAuthProvider.credential(user.email, currentPassword);
        await reauthenticateWithCredential(user, credential);
        
        // Update password
        await updatePassword(user, newPassword);
        
        alert("Password changed successfully!");
        changePasswordModal.style.display = "none";
        changePasswordForm.reset();
        
    } catch (error) {
        console.error("Password change error:", error);
        
        if (error.code === 'auth/wrong-password') {
            alert("Current password is incorrect!");
        } else if (error.code === 'auth/weak-password') {
            alert("New password is too weak. Please use a stronger password.");
        } else {
            alert("Error changing password: " + error.message);
        }
    }
};

/* ===================== MODAL CLOSE LOGIC ===================== */
window.onclick = (event) => { 
    if (event.target == logoutModal) logoutModal.style.display = "none";
    if (event.target == changePasswordModal) {
        changePasswordModal.style.display = "none";
        changePasswordForm.reset();
    }
};
</script>

</body>
</html>
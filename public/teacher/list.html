<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBigkas Admin | Portal</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --maroon: #7a0c0c;
            --gold: #d4af37;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --nav-text: #333;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --danger: #d9534f;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            margin: 0;
            overflow-x: hidden;
            transition: var(--transition);
        }

        /* ===== NAVIGATION & SETTINGS ===== */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5%;
            height: 80px;
            background-color: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--maroon);
        }

        nav .logo { font-size: 1.8rem; font-weight: 800; text-decoration: none; color: var(--maroon); cursor: pointer; }
        nav .logo span { color: var(--gold); }

        nav ul { display: flex; list-style: none; gap: 30px; margin: 0; padding: 0; }
        nav ul li a { text-decoration: none; color: var(--nav-text); font-weight: 600; cursor: pointer; transition: 0.3s; }
        nav ul li a:hover { color: var(--maroon); }

        .nav-actions { display: flex; align-items: center; gap: 15px; position: relative; }

        /* ===== SETTINGS DROPDOWN ===== */
        .settings-container { position: relative; }
        #settingsBtn { 
            background: none; border: 2px solid #eee; padding: 8px 15px; 
            border-radius: 20px; cursor: pointer; font-weight: 600; 
            display: flex; align-items: center; gap: 8px; font-family: 'Poppins';
            color: var(--nav-text);
        }

        .dropdown-menu {
            position: absolute; top: 50px; right: 0; background: var(--card-bg);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-radius: 12px;
            display: none; flex-direction: column; min-width: 180px; overflow: hidden; z-index: 1001;
        }
        .dropdown-menu.show { display: flex; }
        .dropdown-menu button {
            padding: 12px 20px; border: none; background: none; text-align: left;
            cursor: pointer; font-family: 'Poppins'; font-weight: 500; color: var(--nav-text);
        }
        .dropdown-menu button:hover { background: rgba(0,0,0,0.05); }

        /* ===== SECTIONS ===== */
        .container { width: 94%; max-width: 1400px; margin: 30px auto; min-height: 80vh; }
        .hidden { display: none !important; }
        .section-title { text-align: center; margin-bottom: 30px; color: var(--maroon); font-weight: 800; }

        /* ===== DASHBOARD CARDS ===== */
        .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .class-card {
            background: var(--card-bg); padding: 40px 20px; border-radius: 20px;
            text-align: center; cursor: pointer; transition: var(--transition);
            font-size: 1.4rem; font-weight: 700; color: var(--maroon);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-top: 6px solid var(--maroon);
        }
        .class-card:hover { transform: translateY(-8px); background: var(--maroon); color: #fff; }

        /* ===== ANALYTICS VIEW ===== */
        .dashboard-wrapper { display: grid; grid-template-columns: 320px 1fr; gap: 25px; height: 70vh; }
        .sidebar, .main-content { background: var(--card-bg); border-radius: 20px; padding: 25px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .sidebar { border-top: 6px solid var(--gold); }
        .main-content { border-top: 6px solid var(--maroon); }

        .student-btn { 
            background: var(--bg); padding: 12px 20px; margin-bottom: 12px; border-radius: 12px; 
            cursor: pointer; transition: var(--transition); font-weight: 600; display: flex;
            align-items: center; width: 100%; border: 1px solid #eee; color: var(--nav-text); 
        }
        .student-btn.active { background: var(--maroon); color: white; }

        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 12px; }
        .status-online { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
        .status-offline { background-color: #dc3545; }

        .btn-action { background: var(--maroon); color: white; border: none; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: 700; transition: 0.3s; margin-bottom: 20px; }
        .btn-action:hover { opacity: 0.8; }

        /* ===== DARK MODE ===== */
        body.dark-mode { --bg: #121212; --card-bg: #1e1e1e; --nav-text: #ffffff; }
        body.dark-mode #settingsBtn { border-color: #333; }
        body.dark-mode .dropdown-menu button:hover { background: #333; }

        /* ===== DRIP EFFECT ===== */
        #drip-container { position: fixed; inset: 0; pointer-events: none; z-index: 10001; }
        .drip-layer { position: absolute; top: -110%; left: 0; width: 100%; height: 120%; background: #121212; transition: 0.7s; clip-path: url(#drip-path); }
        #drip-container.active .drip-layer { top: 0; }
    </style>
</head>
<body>

<div id="drip-container">
    <div id="dripLayer" class="drip-layer"></div>
    <svg width="0" height="0"><defs><clipPath id="drip-path" clipPathUnits="objectBoundingBox"><path d="M0,0 L1,0 L1,0.8 C0.9,0.95 0.85,0.7 0.75,0.85 C0.65,1 0.55,0.75 0.5,0.9 C0.45,0.75 0.35,1 0.25,0.85 C0.15,0.7 0.1,0.95 0,0.8 Z"></path></clipPath></defs></svg>
</div>

<nav>
    <a onclick="showSection('mainHome')" class="logo">UB<span>igkas</span></a>
    
    <ul>
        <li><a onclick="showSection('mainHome')">Dashboard</a></li>
        <li><a onclick="showSection('reportSection')">Report</a></li>
        <li><a onclick="showSection('classSelection')">Classes</a></li>
    </ul>

    <div class="nav-actions">
        <div class="settings-container">
            <button id="settingsBtn">Settings ‚öôÔ∏è</button>
            <div class="dropdown-menu" id="dropdownMenu">
                <button id="darkModeBtn">üåô Dark Mode</button>
                <button id="navLogoutBtn" style="color:var(--danger)">Logout üö™</button>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div id="mainHome" class="content-section">
        <h2 class="section-title">Welcome to Admin Portal</h2>
        <div style="background: var(--card-bg); padding: 50px; border-radius: 20px; text-align: center; border-top: 6px solid var(--maroon);">
            <h3>Maligayang Pagbabalik!</h3>
            <p>Pumili sa navigation bar para i-manage ang mga klase o tingnan ang mga ulat.</p>
        </div>
    </div>

    <div id="reportSection" class="content-section hidden">
        <h2 class="section-title">Student Performance Reports</h2>
        <div class="main-content" style="width:100%">
            <p style="text-align:center">Dito makikita ang kabuuang report ng mga estudyante.</p>
        </div>
    </div>

    <div id="classSelection" class="content-section hidden">
        <button class="btn-action" onclick="showSection('mainHome')">‚Üê Back to Dashboard</button>
        <h2 class="section-title">Pumili ng Klase</h2>
        <div class="class-grid" id="classGrid"></div>
    </div>

    <div id="dashboardView" class="content-section hidden">
        <button class="btn-action" onclick="showSection('classSelection')">‚Üê Bumalik sa Mga Klase</button>
        <h2 id="currentClassName" class="section-title" style="text-align: left;">Klase</h2>

        <div class="dashboard-wrapper">
            <div class="sidebar">
                <h3 style="margin-bottom:20px; font-size:1.1rem; color: var(--maroon);">Listahan ng Estudyante</h3>
                <div id="studentList"></div>
            </div>

            <div class="main-content" id="analyticsArea">
                <div style="text-align:center; padding-top: 50px; color: #888;">
                    <p>Pumili ng pangalan sa kaliwa para makita ang <b>Analytics</b>.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="logoutModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Logout Confirmation</h3>
        <p>Sigurado ka bang gusto mong mag-logout?</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button id="cancelLogout" class="btn-action" style="background:#eee; color:#333;">Cancel</button>
            <button id="confirmLogout" class="btn-action" style="background:var(--danger)">Logout</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { generateFeedback, resetViewTracker } from "./feedback.js";

const firebaseConfig = {
    apiKey: "AIzaSyC7woa1g1tRQKoepK1m_CQfkyjfwqMcOmc",
    authDomain: "ubigkas-2226b.firebaseapp.com",
    projectId: "ubigkas-2226b",
    storageBucket: "ubigkas-2226b.firebasestorage.app",
    messagingSenderId: "63784933292",
    appId: "1:63784933292:web:fe7ba2b306d429ad5b4c09"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let teacherUID = null;

/* ===== SECTION REDIRECT LOGIC ===== */
window.showSection = function(sectionId) {
    document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
    document.getElementById(sectionId).classList.remove('hidden');
};

/* ===== SETTINGS DROPDOWN ===== */
const settingsBtn = document.getElementById('settingsBtn');
const dropdownMenu = document.getElementById('dropdownMenu');

settingsBtn.onclick = (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle('show');
};

document.onclick = () => dropdownMenu.classList.remove('show');

/* ===== THEME LOGIC ===== */
const darkModeBtn = document.getElementById("darkModeBtn");
darkModeBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    darkModeBtn.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
    localStorage.setItem("theme", isDark ? "dark" : "light");
};

if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    darkModeBtn.textContent = "‚òÄÔ∏è Light Mode";
}

/* ===== AUTH & LOAD ===== */
onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "../index.html"; return; }
    teacherUID = user.uid;
    const teacherDoc = await getDoc(doc(db, "teacher_accounts", teacherUID));
    if (!teacherDoc.exists()) {
        await signOut(auth);
        window.location.href = "../index.html";
        return;
    }
    loadClasses();
});

async function loadClasses() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';
    const classesSnap = await getDocs(collection(db, "teacher_accounts", teacherUID, "classes"));
    classesSnap.forEach(classDoc => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.textContent = classDoc.id;
        card.onclick = () => openDashboard(classDoc.id);
        grid.appendChild(card);
    });
}

window.openDashboard = async function(classId) {
    showSection('dashboardView');
    document.getElementById('currentClassName').textContent = "Klase: " + classId;

    const studentListDiv = document.getElementById('studentList');
    studentListDiv.innerHTML = '';

    const studentsSnap = await getDocs(collection(db, "students"));
    studentsSnap.forEach(studentDoc => {
        const data = studentDoc.data();
        if (data.classId !== classId) return;

        const studentID = studentDoc.id;
        const btn = document.createElement('button');
        btn.className = 'student-btn';
        btn.innerHTML = `<span id="status-dot-${studentID}" class="status-dot ${data.status === 'online' ? 'status-online' : 'status-offline'}"></span>${data.name ?? studentID}`;
        btn.onclick = (e) => showAnalytics(studentID, data.name, e);
        studentListDiv.appendChild(btn);
    });
}

// ... rest of your analytics and charting logic ...

/* ===== LOGOUT ===== */
const logoutModal = document.getElementById("logoutModal");
document.getElementById("navLogoutBtn").onclick = () => logoutModal.style.display = "flex";
document.getElementById("cancelLogout").onclick = () => logoutModal.style.display = "none";
document.getElementById("confirmLogout").onclick = async () => {
    const dripLayer = document.getElementById("dripLayer");
    dripLayer.classList.toggle("drip-light", !document.body.classList.contains("dark-mode"));
    document.getElementById("drip-container").classList.add("active");
    setTimeout(async () => {
        await signOut(auth);
        window.location.href = "../index.html";
    }, 700);
};
</script>
</body>
</html>
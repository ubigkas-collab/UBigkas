<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBigkas Admin | Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --maroon: #7a0c0c;
            --maroon-dark: #5c0808;
            --gold: #d4af37;
            --gold-light: #f5e7b2;
            --white-bg: #f8f9fa; 
            --card-bg: #ffffff;
            --text-dark: #222222;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --overlay-color: #121212;
            --danger: #d9534f;
            --success: #28a745;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            background-color: var(--white-bg);
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        body.dark-mode { background-color: #181818; color: #e6e6e6; }

        #theme-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            transform: translateY(-100%);
            background-color: var(--overlay-color);
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 90% 85%, 80% 100%, 70% 88%, 60% 100%, 50% 82%, 40% 100%, 30% 85%, 20% 100%, 10% 88%, 0% 100%);
        }

        .dripping { animation: paintDrip 1.2s cubic-bezier(0.45, 0, 0.55, 1) forwards; }

        @keyframes paintDrip {
            0% { transform: translateY(-100%); }
            50% { transform: translateY(0%); }
            100% { transform: translateY(100%); }
        }

        nav {
            display: flex;
            align-items: center;
            padding: 1rem 5%;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
            border-bottom: 3px solid var(--maroon);
        }

        body.dark-mode nav { background-color: #202020; border-bottom-color: var(--maroon); }
        nav .logo { font-size: 1.8rem; font-weight: 800; text-decoration: none; color: var(--maroon); cursor: pointer; }
        nav .logo span { color: var(--gold); }
        nav ul { display: flex; list-style: none; gap: 20px; margin-left: 30px; }
        nav ul li a { text-decoration: none; color: #333; font-weight: 600; transition: 0.3s; cursor: pointer; }
        body.dark-mode nav ul li a { color: #e6e6e6; }

        .nav-actions { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        #logoutBtn { padding: 8px 20px; border-radius: 25px; background-color: var(--danger); color: white; border: none; cursor: pointer; font-weight: 600; }
        #darkModeBtn { padding: 8px 12px; border-radius: 25px; background-color: #333; color: #fff; border: none; cursor: pointer; }

        .container { width: 94%; max-width: 1400px; margin: 30px auto; flex: 1; padding-bottom: 40px; }
        .section-title { text-align: center; margin-bottom: 25px; color: var(--maroon); font-weight: 700; }
        body.dark-mode .section-title { color: var(--gold); }

        /* ACTION BAR (Create Class/Add Student) */
        .action-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .btn-action { 
            padding: 10px 25px; border-radius: 50px; border: none; cursor: pointer; 
            font-weight: 600; transition: var(--transition); background: var(--maroon); color: white;
        }
        .btn-action:hover { background: var(--maroon-dark); transform: scale(1.05); }

        .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .class-card {
            background: var(--card-bg); padding: 40px 20px; border-radius: 20px;
            text-align: center; cursor: pointer; transition: var(--transition); 
            font-size: 1.4rem; font-weight: 700; color: var(--maroon);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-top: 6px solid var(--maroon);
        }
        body.dark-mode .class-card { background-color: #242424; color: #e6e6e6; border-color: var(--gold); }
        .class-card:hover { background: var(--maroon); color: #fff; }

        .dashboard-wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 25px; margin-top: 20px; height: 75vh; }
        .sidebar { background: #fff; border-radius: 20px; padding: 25px; overflow-y: auto; border-top: 6px solid var(--gold); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        body.dark-mode .sidebar { background: #242424; }

        .main-content { background: #fff; border-radius: 20px; padding: 40px; border-top: 6px solid var(--maroon); overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        body.dark-mode .main-content { background: #242424; }

        .student-btn { 
            background: #f8f9fa; padding: 12px 20px; margin-bottom: 12px; border-radius: 12px; 
            cursor: pointer; width: 100%; border: 1px solid #eee; display: flex; align-items: center; font-weight: 600;
        }
        body.dark-mode .student-btn { background: #333; color: #fff; border-color: #444; }
        .student-btn.active { background: var(--maroon); color: white; }

        .status-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }

        .btn-back { background: transparent; color: var(--maroon); border: 2px solid var(--maroon); padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 700; margin-bottom: 20px; }
        
        .hidden { display: none !important; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        body.dark-mode .modal-card { background: #242424; color: #fff; }
        .modal-card input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 10px; border: 1px solid #ddd; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }

        .feedback-item { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--maroon); }
        body.dark-mode .feedback-item { background: #333; border-left-color: var(--gold); }
    </style>
</head>
<body>

<div id="theme-overlay"></div>

<nav>
    <a onclick="showNavSection('home')" class="logo">UB<span>igkas</span></a>
    <ul>
        <li><a onclick="showNavSection('home')">Dashboard</a></li>
        <li><a onclick="showNavSection('list')">List</a></li>
        <li><a onclick="showNavSection('about')">About</a></li>
        <li><a onclick="showNavSection('contact')">Contact</a></li>
    </ul>
    <div class="nav-actions">
        <button id="darkModeBtn">üåô</button>
        <button id="logoutBtn">Logout</button>
    </div>
</nav>

<div class="container">
    <div id="homeSection" class="nav-content">
        <div class="main-content" style="text-align: center; padding: 80px 20px;">
            <h1 class="section-title">Teacher Portal</h1>
            <p>Welcome back! Manage your classes and track student progress.</p>
            <div class="action-bar" style="margin-top: 30px;">
                <button class="btn-action" onclick="showNavSection('list')">Go to Class List</button>
            </div>
        </div>
    </div>

    <div id="classSelection" class="nav-content hidden">
        <h2 class="section-title">Mga Klase</h2>
        <div class="action-bar">
            <button class="btn-action" onclick="document.getElementById('createClassModal').style.display='flex'">+ Gawa ng Klase</button>
            <button class="btn-action" style="background: var(--gold); color: #000;" onclick="document.getElementById('addStudentModal').style.display='flex'">+ Dagdag Estudyante</button>
        </div>
        <div class="class-grid" id="classGrid"></div>
    </div>

    <div id="dashboardView" class="nav-content hidden">
        <button class="btn-back" onclick="showNavSection('list')">‚Üê Bumalik sa Listahan</button>
        <h2 id="currentClassName" class="section-title" style="text-align: left;">Klase</h2>
        <div class="dashboard-wrapper">
            <div class="sidebar">
                <h3 style="margin-bottom:20px; color: var(--maroon);">Listahan ng Estudyante</h3>
                <div id="studentList"></div>
            </div>
            <div class="main-content" id="analyticsArea">
                <p>Pumili ng estudyante sa kaliwa.</p>
            </div>
        </div>
    </div>
</div>

<div id="createClassModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Bagong Klase</h3>
        <input type="text" id="newClassName" placeholder="Halimbawa: Grade 10 - Rizal">
        <div class="modal-actions">
            <button class="btn-action" style="background: #eee; color: #333;" onclick="this.closest('.modal-overlay').style.display='none'">Cancel</button>
            <button class="btn-action" id="confirmCreateClass">Create</button>
        </div>
    </div>
</div>

<div id="addStudentModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Dagdag Estudyante</h3>
        <input type="text" id="newStudentName" placeholder="Pangalan ng Estudyante">
        <input type="text" id="targetClassId" placeholder="Class ID">
        <div class="modal-actions">
            <button class="btn-action" style="background: #eee; color: #333;" onclick="this.closest('.modal-overlay').style.display='none'">Cancel</button>
            <button class="btn-action" id="confirmAddStudent">Add</button>
        </div>
    </div>
</div>

<div id="logoutModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Logout Confirmation</h3>
        <div class="modal-actions">
            <button class="btn-action" style="background: #eee; color: #333;" onclick="document.getElementById('logoutModal').style.display='none'">Cancel</button>
            <button class="btn-action" style="background: var(--danger);" id="confirmLogout">Logout</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { generateFeedback, resetViewTracker } from "./feedback.js";

const firebaseConfig = {
    apiKey: "AIzaSyC7woa1g1tRQKoepK1m_CQfkyjfwqMcOmc",
    authDomain: "ubigkas-2226b.firebaseapp.com",
    projectId: "ubigkas-2226b",
    storageBucket: "ubigkas-2226b.firebasestorage.app",
    messagingSenderId: "63784933292",
    appId: "1:63784933292:web:fe7ba2b306d429ad5b4c09"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let teacherUID = null;

// --- NAVIGATION ---
window.showNavSection = function(section) {
    document.querySelectorAll('.nav-content').forEach(el => el.classList.add('hidden'));
    if(section === 'home') document.getElementById('homeSection').classList.remove('hidden');
    else if(section === 'list') document.getElementById('classSelection').classList.remove('hidden');
};

// --- CREATE CLASS ---
document.getElementById('confirmCreateClass').onclick = async () => {
    const name = document.getElementById('newClassName').value;
    if(!name) return;
    await setDoc(doc(db, "teacher_accounts", teacherUID, "classes", name), { createdAt: new Date() });
    location.reload();
};

// --- ADD STUDENT ---
document.getElementById('confirmAddStudent').onclick = async () => {
    const name = document.getElementById('newStudentName').value;
    const cid = document.getElementById('targetClassId').value;
    if(!name || !cid) return;
    await setDoc(doc(collection(db, "students")), { name: name, classId: cid, status: "offline" });
    alert("Student Added!");
    location.reload();
};

// --- AUTH & LOAD ---
onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "../index.html"; return; }
    teacherUID = user.uid;
    loadClasses();
});

async function loadClasses() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';
    const snap = await getDocs(collection(db, "teacher_accounts", teacherUID, "classes"));
    snap.forEach(c => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.textContent = c.id;
        card.onclick = () => openDashboard(c.id);
        grid.appendChild(card);
    });
}

window.openDashboard = async function(classId) {
    document.querySelectorAll('.nav-content').forEach(el => el.classList.add('hidden'));
    document.getElementById('dashboardView').classList.remove('hidden');
    document.getElementById('currentClassName').textContent = "Klase: " + classId;
    
    const list = document.getElementById('studentList');
    list.innerHTML = '';
    const snap = await getDocs(collection(db, "students"));
    snap.forEach(s => {
        const data = s.data();
        if(data.classId !== classId) return;
        const btn = document.createElement('button');
        btn.className = 'student-btn';
        btn.innerHTML = `<span class="status-dot ${data.status === 'online' ? 'status-online' : 'status-offline'}"></span> ${data.name}`;
        btn.onclick = (e) => showAnalytics(s.id, data.name, e);
        list.appendChild(btn);
    });
};

window.showAnalytics = async function(id, name, event) {
    document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    const area = document.getElementById('analyticsArea');
    area.innerHTML = `Loading ${name}...`;
    
    const snap = await getDocs(collection(db, "students", id, "assessments"));
    if(snap.empty) { area.innerHTML = "No data."; return; }

    area.innerHTML = `<canvas id="chart" height="200"></canvas><div id="feed"></div>`;
    // Chart rendering logic remains same as original...
};

// --- LOGOUT & THEME (Standard Logic) ---
document.getElementById('logoutBtn').onclick = () => document.getElementById('logoutModal').style.display='flex';
document.getElementById('confirmLogout').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
</script>
</body>
</html>
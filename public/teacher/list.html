<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBigkas Admin | Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --maroon: #7a0c0c;
            --maroon-dark: #5c0808;
            --gold: #d4af37;
            --gold-light: #f5e7b2;
            --white-bg: #f8f9fa; 
            --card-bg: #ffffff;
            --text-dark: #222222;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --overlay-color: #121212;
            --danger: #d9534f;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            background-color: var(--white-bg);
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        /* ===== Dark Mode Global Overrides ===== */
        body.dark-mode {
            background-color: #181818;
            color: #e6e6e6;
        }

        /* ===== Dripping Paint System ===== */
        #theme-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            transform: translateY(-100%);
            background-color: var(--overlay-color);
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 90% 85%, 80% 100%, 70% 88%, 60% 100%, 50% 82%, 40% 100%, 30% 85%, 20% 100%, 10% 88%, 0% 100%);
        }

        .dripping {
            animation: paintDrip 1.2s cubic-bezier(0.45, 0, 0.55, 1) forwards;
        }

        @keyframes paintDrip {
            0% { transform: translateY(-100%); }
            50% { transform: translateY(0%); }
            100% { transform: translateY(100%); }
        }

        /* ===== Nav Style (Integrated) ===== */
        nav {
            display: flex;
            align-items: center;
            padding: 1rem 5%;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
            border-bottom: 3px solid var(--maroon);
        }

        body.dark-mode nav { background-color: #202020; border-bottom-color: var(--maroon); }

        nav .logo { font-size: 1.8rem; font-weight: 800; text-decoration: none; color: var(--maroon); }
        nav .logo span { color: var(--gold); }

        nav ul { display: flex; list-style: none; gap: 20px; margin-left: 30px; }
        nav ul li a { text-decoration: none; color: #333; font-weight: 500; transition: 0.3s; }
        body.dark-mode nav ul li a { color: #e6e6e6; }

        .nav-actions { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        #logoutBtn {
            padding: 8px 20px;
            border-radius: 25px;
            background-color: var(--danger);
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        #darkModeBtn {
            padding: 8px 12px;
            border-radius: 25px;
            background-color: #333;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        /* ===== Dashboard View Layout ===== */
        .container { width: 94%; max-width: 1400px; margin: 30px auto; flex: 1; padding-bottom: 40px; }

        .section-title { text-align: center; margin-bottom: 25px; color: var(--maroon); font-weight: 700; }
        body.dark-mode .section-title { color: var(--gold); }

        .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }

        .class-card {
            background: var(--card-bg); 
            padding: 40px 20px; 
            border-radius: 20px;
            text-align: center; 
            cursor: pointer; 
            transition: var(--transition); 
            font-size: 1.4rem; 
            font-weight: 700;
            color: var(--maroon);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border-top: 6px solid var(--maroon);
        }

        body.dark-mode .class-card { background-color: #242424; color: #e6e6e6; border-color: var(--gold); }

        .class-card:hover { transform: translateY(-8px); background: var(--maroon); color: #fff; }

        .dashboard-wrapper { 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 25px; 
            margin-top: 20px; 
            height: 75vh; 
        }

        .sidebar { 
            background: #fff; 
            border-radius: 20px; 
            padding: 25px; 
            overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border-top: 6px solid var(--gold);
        }
        body.dark-mode .sidebar { background: #242424; border-top-color: var(--gold); }

        .main-content { 
            background: #fff; 
            border-radius: 20px; 
            padding: 40px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border-top: 6px solid var(--maroon);
            overflow-y: auto;
        }
        body.dark-mode .main-content { background: #242424; border-top-color: var(--maroon); }

        .student-btn { 
            background: #f8f9fa; 
            padding: 12px 20px; 
            margin-bottom: 12px; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: var(--transition); 
            font-weight: 600; 
            display: flex;
            align-items: center;
            width: 100%; 
            border: 1px solid #eee; 
            color: var(--text-dark); 
        }
        body.dark-mode .student-btn { background: #333; color: #fff; border-color: #444; }
        .student-btn:hover { border-color: var(--maroon); background: #fff; color: var(--maroon); }
        .student-btn.active { background: var(--maroon); color: white; border-color: var(--maroon); }

        .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }

        .btn-back { 
            background: transparent; 
            color: var(--maroon); 
            border: 2px solid var(--maroon); 
            padding: 10px 20px; 
            border-radius: 50px; 
            cursor: pointer; 
            margin-bottom: 20px; 
            font-weight: 700; 
        }
        body.dark-mode .btn-back { color: var(--gold); border-color: var(--gold); }

        .hidden { display: none; }
        .footer-credit { text-align: center; padding: 20px; color: #bbb; font-size: 0.9rem; }

        /* ===== Logout Modal (Integrated) ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-card {
            background: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 400px; text-align: center;
        }
        body.dark-mode .modal-card { background: #242424; color: #fff; }
        .modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .modal-btn { padding: 10px 25px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; }
        .modal-btn.primary { background-color: #d9534f; color: white; }
        .modal-btn.secondary { background-color: #e9ecef; color: #333; }

        /* ADDED FEEDBACK CSS */
        .feedback-section { width: 100%; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        body.dark-mode .feedback-section { border-top-color: #444; }
        .feedback-item { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; line-height: 1.4; border-left: 5px solid var(--maroon); }
        body.dark-mode .feedback-item { background: #333; color: #eee; border-left-color: var(--gold); }
    </style>
</head>
<body>

<div id="theme-overlay"></div>

<nav>
    <a href="#" class="logo">UB<span>igkasAdmin.</span></a>
    <ul>
        <li><a href="#">Dashboard</a></li>
        <li><a href="#">Report</a></li>
    </ul>
    <div class="nav-actions">
        <button id="darkModeBtn">üåô</button>
        <button id="logoutBtn">Logout</button>
    </div>
</nav>

<div class="container">
    <div id="classSelection">
        <h2 class="section-title">Pumili ng Klase</h2>
        <div class="class-grid" id="classGrid"></div>
    </div>

    <div id="dashboardView" class="hidden">
        <button class="btn-back" onclick="goBack()">‚Üê Bumalik sa Listahan</button>
        <h2 id="currentClassName" class="section-title" style="text-align: left;">Klase</h2>

        <div class="dashboard-wrapper">
            <div class="sidebar">
                <h3 style="margin-bottom:20px; font-size:1.1rem; color: var(--maroon);">Listahan ng Estudyante</h3>
                <div id="studentList"></div>
            </div>

            <div class="main-content" id="analyticsArea">
                <div class="analytics-placeholder">
                    <p>Pumili ng pangalan sa kaliwa para makita ang <b>Analytics</b>.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="logoutModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Logout Confirmation</h3>
        <p>Sigurado ka bang gusto mong mag-logout?</p>
        <div class="modal-actions">
            <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
            <button id="confirmLogout" class="modal-btn primary">Logout</button>
        </div>
    </div>
</div>

<div class="footer-credit">¬©2025 University of Batangas ‚Äì Admin Portal</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
// ADDED IMPORT
import { generateFeedback, resetViewTracker } from "./feedback.js";

const firebaseConfig = {
    apiKey: "AIzaSyC7woa1g1tRQKoepK1m_CQfkyjfwqMcOmc",
    authDomain: "ubigkas-2226b.firebaseapp.com",
    projectId: "ubigkas-2226b",
    storageBucket: "ubigkas-2226b.firebasestorage.app",
    messagingSenderId: "63784933292",
    appId: "1:63784933292:web:fe7ba2b306d429ad5b4c09"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let teacherUID = null;

// ---------------- DARK MODE LOGIC (Integrated) ----------------
const darkModeBtn = document.getElementById("darkModeBtn");
const themeOverlay = document.getElementById("theme-overlay");

darkModeBtn.onclick = () => {
    const isCurrentlyDark = document.body.classList.contains("dark-mode");
    themeOverlay.style.backgroundColor = isCurrentlyDark ? "#f8f9fa" : "#181818";
    themeOverlay.classList.remove("dripping");
    void themeOverlay.offsetWidth; 
    themeOverlay.classList.add("dripping");

    setTimeout(() => {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        darkModeBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }, 600);
};

if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    darkModeBtn.textContent = "‚òÄÔ∏è";
}

// ---------------- LOGOUT MODAL LOGIC ----------------
const logoutBtn = document.getElementById("logoutBtn");
const logoutModal = document.getElementById("logoutModal");
const cancelLogout = document.getElementById("cancelLogout");
const confirmLogout = document.getElementById("confirmLogout");

logoutBtn.onclick = () => { logoutModal.style.display = "flex"; };
cancelLogout.onclick = () => { logoutModal.style.display = "none"; };
confirmLogout.onclick = async () => {
    await signOut(auth);
    window.location.href = "../index.html";
};

// ---------------- AUTH + ROLE GUARD ----------------
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "../index.html";
        return;
    }
    teacherUID = user.uid;
    const teacherDoc = await getDoc(doc(db, "teacher_accounts", teacherUID));
    if (!teacherDoc.exists()) {
        alert("Access denied. Teachers only.");
        await signOut(auth);
        window.location.href = "../index.html";
        return;
    }
    loadClasses();
});

// ---------------- LOAD TEACHER CLASSES ----------------
async function loadClasses() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';
    try {
        const classesSnap = await getDocs(collection(db, "teacher_accounts", teacherUID, "classes"));
        classesSnap.forEach(classDoc => {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.textContent = classDoc.id;
            card.onclick = () => openDashboard(classDoc.id);
            grid.appendChild(card);
        });
    } catch (err) {
        console.error(err);
    }
}

// ---------------- DASHBOARD & STATUS ----------------
window.openDashboard = async function(classId) {
    document.getElementById('classSelection').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    document.getElementById('currentClassName').textContent = "Klase: " + classId;

    const studentListDiv = document.getElementById('studentList');
    studentListDiv.innerHTML = '';

    try {
        const studentsSnap = await getDocs(collection(db, "students"));
        studentsSnap.forEach(studentDoc => {
            const data = studentDoc.data();
            if (data.classId !== classId) return;

            const studentName = data.name ?? studentDoc.id;
            const studentID = studentDoc.id;

            const btn = document.createElement('button');
            btn.className = 'student-btn';
            btn.id = "student-btn-" + studentID;

            const dot = document.createElement('span');
            dot.className = 'status-dot ' + ((data.status === "online") ? 'status-online' : 'status-offline');
            dot.id = "status-dot-" + studentID;
            btn.appendChild(dot);

            const nameText = document.createTextNode(studentName);
            btn.appendChild(nameText);

            btn.onclick = (e) => showAnalytics(studentID, studentName, e);
            studentListDiv.appendChild(btn);

            onSnapshot(doc(db, "students", studentID), (snap) => {
                const statusDot = document.getElementById("status-dot-" + studentID);
                if (statusDot) {
                    const status = snap.data()?.status || "offline";
                    statusDot.className = "status-dot " + (status === "online" ? "status-online" : "status-offline");
                }
            });
        });
    } catch (err) { console.error(err); }
}

// ---------------- SHOW ANALYTICS ----------------
window.showAnalytics = async function(studentID, studentName, event) {
    document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
    // Ensure we target the button if dot was clicked
    const targetBtn = event.target.closest('.student-btn');
    if (targetBtn) targetBtn.classList.add('active');

    const area = document.getElementById('analyticsArea');
    area.innerHTML = `<p class="analytics-placeholder">Loading analytics for ${studentName}...</p>`;

    try {
        const assessmentsRef = collection(db, "students", studentID, "assessments");
        const snapshot = await getDocs(assessmentsRef);

        if (snapshot.empty) {
            area.innerHTML = `<p class="analytics-placeholder">${studentName} has no assessment records yet.</p>`;
            return;
        }

        const scoresMap = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            const quizType = data.quizType || doc.id;
            const score = data.score ?? 0;
            const total = data.total ?? 1;
            if (!scoresMap[quizType] || score > scoresMap[quizType].score) {
                scoresMap[quizType] = { score, total };
            }
        });

        const labels = [];
        const percentages = [];

        for (const [quiz, val] of Object.entries(scoresMap)) {
            labels.push(quiz);
            percentages.push(Math.round((val.score / val.total) * 100));
        }

        // ADDED FEEDBACK CONTAINER TO HTML OUTPUT
        area.innerHTML = `
            <canvas id="studentScoreChart" height="220"></canvas>
            <div class="feedback-section" id="feedbackContainer">
                <h3 style="margin-bottom:15px; font-size:1.1rem; color: var(--maroon);">Performance Insight</h3>
            </div>
        `;
        
        renderStudentChart(labels, percentages);

        // ADDED FEEDBACK GENERATION LOOP
        const feedbackContainer = document.getElementById('feedbackContainer');
        resetViewTracker(); // Ensure no repeats in this view
        for (const [quiz, val] of Object.entries(scoresMap)) {
            const pct = Math.round((val.score / val.total) * 100);
            const feedbackText = generateFeedback(quiz, pct);
            const div = document.createElement('div');
            div.className = 'feedback-item';
            div.innerHTML = `<strong>${quiz}:</strong> ${feedbackText}`;
            feedbackContainer.appendChild(div);
        }

    } catch (err) { console.error(err); }
};

function renderStudentChart(labels, scores) {
    const isDark = document.body.classList.contains("dark-mode");
    const ctx = document.getElementById("studentScoreChart").getContext("2d");
    new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: 'Score Percentage',
                data: scores,
                backgroundColor: ["#7a0c0c", "#d4af37", "#5c0808", "#b5651d", "#a83279"],
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { min: 0, max: 100, ticks: { color: isDark ? '#fff' : '#666', callback: v => v + "%" }, grid: { color: isDark ? '#444' : '#eee' } },
                x: { ticks: { color: isDark ? '#fff' : '#666' }, grid: { display: false } }
            }
        }
    });
}

window.goBack = function() {
    document.getElementById('classSelection').classList.remove('hidden');
    document.getElementById('dashboardView').classList.add('hidden');
}
</script>
</body>
</html>
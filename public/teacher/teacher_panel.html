<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard | UBigkas</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="teacher_panel.css">

    <style>
        /* --- CONSTANTS & ROOTS --- */
        :root {
            --maroon: #7a0c0c;
            --gold: #d4af37;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --overlay-color: #121212;
            --danger: #d9534f;
            --danger-hover: #c9302c;
            --info: #1b2e4b;
        }

        /* --- CUSTOM TOAST SYSTEM --- */
        #toast-container { position: fixed; top: 25px; right: 25px; z-index: 9999; }
        .toast {
            min-width: 280px;
            padding: 16px 24px;
            margin-bottom: 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            animation: slideIn 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            border-left: 5px solid var(--gold);
        }
        .toast.success { background-color: var(--maroon); } 
        .toast.info { background-color: var(--info); }
        .toast.error { background-color: #b32d2d; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }

        /* --- DRIPPING PAINT SYSTEM --- */
        #theme-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            transform: translateY(-100%);
            background-color: var(--overlay-color);
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 90% 85%, 80% 100%, 70% 88%, 60% 100%, 50% 82%, 40% 100%, 30% 85%, 20% 100%, 10% 88%, 0% 100%);
        }

        .dripping {
            animation: paintDrip 1.2s cubic-bezier(0.45, 0, 0.55, 1) forwards;
        }

        @keyframes paintDrip {
            0% { transform: translateY(-100%); }
            50% { transform: translateY(0%); }
            100% { transform: translateY(100%); }
        }

        /* --- DASHBOARD STYLES --- */
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: background 0.5s ease;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
            margin: 0;
        }

        body.dark-mode {
            background: #181818;
            color: #e6e6e6;
        }

        nav {
            display: flex;
            align-items: center;
            padding: 1rem 5%;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
        }

        body.dark-mode nav { background-color: #202020; }
        nav .logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; color: var(--maroon); }
        nav .logo span { color: var(--gold); }
        nav ul { display: flex; list-style: none; gap: 20px; margin-left: 30px; }
        nav ul li a { text-decoration: none; color: #333; font-weight: 500; transition: 0.3s; }
        body.dark-mode nav ul li a { color: #e6e6e6; }
        .nav-actions { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        #logoutBtn {
            padding: 10px 25px;
            border-radius: 25px;
            background-color: var(--danger);
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #logoutBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            background-color: var(--danger-hover);
        }

        #darkModeBtn {
            padding: 10px 15px;
            border-radius: 25px;
            background-color: #333;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }

        .dashboard-card {
            background: #fff;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin: 40px auto;
            max-width: 900px;
            animation: fadeInUp 0.8s ease-out;
        }

        body.dark-mode .dashboard-card {
            background-color: #242424;
            color: #e6e6e6;
            border: 1px solid #333;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-card {
            background: white;
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            position: relative;
        }

        body.dark-mode .modal-card { background: #242424; color: #e6e6e6; border: 1px solid #333; }
        .modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .modal-btn {
            padding: 10px 25px; border-radius: 25px; border: none;
            font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;
            transition: 0.3s;
        }
        .modal-btn.primary { background-color: var(--danger); color: white; }
        .modal-btn.secondary { background-color: #e9ecef; color: #333; }
        body.dark-mode .modal-btn.secondary { background-color: #333; color: #fff; }

        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-maroon { background-color: var(--maroon); color: white; }
        .btn-gold { background-color: var(--gold); color: white; }

        .footer-credit {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        body.dark-mode .footer-credit { color: #999; }
    </style>
</head>
<body>

<div id="theme-overlay"></div>
<div id="toast-container"></div>

<nav>
    <a href="index.html" class="logo">UB<span>igkas</span></a>
    <ul>
        <li><a href="teacher_panel.html">Home</a></li>
        <li><a href="list.html">List</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Contact</a></li>
    </ul>

    <div class="nav-actions">
        <button id="darkModeBtn">ðŸŒ™</button>
        <button id="logoutBtn">Logout</button>
    </div>
</nav>

<div id="logoutModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Logout Confirmation</h3>
        <p>Are you sure you want to logout?</p>
        <div class="modal-actions">
            <button id="cancelLogout" class="modal-btn secondary">Cancel</button>
            <button id="confirmLogout" class="modal-btn primary">Logout</button>
        </div>
    </div>
</div>

<main class="dashboard-container">
    <div class="dashboard-card">
        <h1>Teacher Dashboard</h1>
        <p class="subtitle" style="color: #666;">Manage students, classes, and learning materials.</p>

        <div class="test-buttons" style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn btn-maroon" id="openStudentCardBtn">Add Student</button>
            <button class="btn btn-gold" id="openClassCardBtn">Create Class</button>
        </div>
    </div>
</main>

<div id="studentCard" class="modal-overlay">
    <div class="modal-card" style="text-align: left;">
        <h2 style="margin-top: 0; color: var(--maroon);">Add New Student</h2>
        <form id="studentForm">
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px;">Full Name</label>
                <input id="studentNameInput" type="text" placeholder="Juan Dela Cruz" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px;">Email Address</label>
                <input id="studentEmail" type="email" placeholder="1234567@ub.edu.ph" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box;">
                <small id="emailHelp" style="display: block; font-size: 0.7rem; color: #888; margin-top: 4px;">Must be 7 digits + @ub.edu.ph</small>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px;">Temporary Password</label>
                <input id="studentPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px;">Assigned Class</label>
                <select id="classSelect" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" id="closeStudentCardBtn" class="modal-btn secondary" style="flex: 1;">Cancel</button>
                <button type="submit" class="modal-btn primary" style="flex: 2; background-color: var(--maroon);">âœ¨ Create Account</button>
            </div>
        </form>
    </div>
</div>

<div id="classCard" class="modal-overlay">
    <div class="modal-card">
        <h2 style="color: var(--gold);">Create New Class</h2>
        <form id="classForm">
            <div style="margin-bottom: 20px; text-align: left;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px;">Class Name / Section</label>
                <input id="className" type="text" placeholder="e.g. GRADE-10-A" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" id="closeClassCardBtn" class="modal-btn secondary" style="flex: 1;">Cancel</button>
                <button type="submit" class="modal-btn primary" style="flex: 2; background-color: var(--gold);">Add Class</button>
            </div>
        </form>
    </div>
</div>

<footer class="footer-credit">
    Â©2026 University of Batangas â€“ Lipa City
</footer>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    (function(){ emailjs.init("vRoWpjpDgjKcQPN7C"); })();
</script>

<script type="module">
    import { auth, db } from "../firebase.js";
    import { createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, setDoc, serverTimestamp, collection, getDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    let teacherUID = null;

    /* --- TOAST LOGIC --- */
    function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = "fadeOut 0.5s ease forwards";
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    /* --- THEME LOGIC --- */
    const darkModeBtn = document.getElementById("darkModeBtn");
    const themeOverlay = document.getElementById("theme-overlay");

    darkModeBtn.onclick = () => {
        const isCurrentlyDark = document.body.classList.contains("dark-mode");
        themeOverlay.style.backgroundColor = isCurrentlyDark ? "#f8f9fa" : "#181818";
        themeOverlay.classList.remove("dripping");
        void themeOverlay.offsetWidth; 
        themeOverlay.classList.add("dripping");

        setTimeout(() => {
            document.body.classList.toggle("dark-mode");
            const isDark = document.body.classList.contains("dark-mode");
            darkModeBtn.textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
            localStorage.setItem("theme", isDark ? "dark" : "light");
        }, 600);
    };

    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
        darkModeBtn.textContent = "â˜€ï¸";
    }

    const modals = {
        student: document.getElementById("studentCard"),
        class: document.getElementById("classCard"),
        logout: document.getElementById("logoutModal")
    };

    document.getElementById("openStudentCardBtn").onclick = () => modals.student.style.display = "flex";
    document.getElementById("closeStudentCardBtn").onclick = () => modals.student.style.display = "none";
    document.getElementById("openClassCardBtn").onclick = () => modals.class.style.display = "flex";
    document.getElementById("closeClassCardBtn").onclick = () => modals.class.style.display = "none";
    document.getElementById("logoutBtn").onclick = () => modals.logout.style.display = "flex";
    document.getElementById("cancelLogout").onclick = () => modals.logout.style.display = "none";

    window.onclick = (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            Object.values(modals).forEach(m => m.style.display = "none");
        }
    };

    onAuthStateChanged(auth, async user => {
        if (!user) return window.location.href = "../index.html";
        teacherUID = user.uid;
        const teacherDoc = await getDoc(doc(db, "teacher_accounts", teacherUID));
        if (!teacherDoc.exists()) {
            await signOut(auth);
            window.location.href = "../index.html";
            return;
        }
        listenForClasses();
    });

    document.getElementById("confirmLogout").onclick = async () => {
        await signOut(auth);
        window.location.href = "../index.html";
    };

    function listenForClasses() {
        const classesCol = collection(db, "teacher_accounts", teacherUID, "classes");
        onSnapshot(classesCol, snap => {
            const select = document.getElementById("classSelect");
            select.innerHTML = '<option value="">Select Class</option>';
            snap.forEach(docSnap => {
                const opt = document.createElement("option");
                opt.value = docSnap.id; opt.textContent = docSnap.data().name;
                select.appendChild(opt);
            });
        });
    }

    const secondaryApp = initializeApp({
        apiKey: "AIzaSyC7woa1g1tRQKoepK1m_CQfkyjfwqMcOmc",
        authDomain: "ubigkas-2226b.firebaseapp.com",
        projectId: "ubigkas-2226b",
    }, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    /* --- STUDENT FORM WITH DUPLICATION & FORMAT CHECK --- */
    document.getElementById("studentForm").onsubmit = async e => {
        e.preventDefault();
        const name = document.getElementById("studentNameInput").value.trim();
        const email = document.getElementById("studentEmail").value.trim().toLowerCase();
        const password = document.getElementById("studentPassword").value;
        const classSelect = document.getElementById("classSelect");

        // --- EMAIL FORMAT VALIDATION (7 digits + @ub.edu.ph) ---
        const ubEmailRegex = /^\d{7}@ub\.edu\.ph$/;
        if (!ubEmailRegex.test(email)) {
            showToast("Invalid email format. Use 7 digits followed by @ub.edu.ph", "error");
            return;
        }

        try {
            // Check if student email already exists in Firestore
            const q = query(collection(db, "students"), where("email", "==", email));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                showToast("Account already exists with this email.", "error");
                return;
            }

            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
            await setDoc(doc(db, "students", cred.user.uid), {
                uid: cred.user.uid, name, email, classId: classSelect.value, 
                className: classSelect.options[classSelect.selectedIndex].text,
                teacherUID, role: "student", createdAt: serverTimestamp()
            });

            await emailjs.send("service_hxj7n1j", "template_wzxxy9g", {
                student_name: name, student_email: email, student_password: password, class_name: classSelect.options[classSelect.selectedIndex].text
            });

            showToast("Student account created and email sent!", "success");
            modals.student.style.display = "none";
            e.target.reset();
        } catch (err) { 
            if (err.code === 'auth/email-already-in-use') {
                showToast("Email is already registered in the system.", "error");
            } else {
                showToast(err.message, "error"); 
            }
        }
    };

    /* --- CLASS FORM --- */
    document.getElementById("classForm").onsubmit = async e => {
        e.preventDefault();
        const name = document.getElementById("className").value.trim().toUpperCase();
        
        try {
            const classDocRef = doc(db, "teacher_accounts", teacherUID, "classes", name);
            const classDoc = await getDoc(classDocRef);

            if (classDoc.exists()) {
                showToast("Class section already exists!", "error");
                return;
            }

            await setDoc(classDocRef, { name, createdAt: serverTimestamp(), createdBy: teacherUID });
            showToast("Class section created successfully!", "success");
            modals.class.style.display = "none";
            e.target.reset();
        } catch (err) { showToast(err.message, "error"); }
    };
</script>
</body>
</html>